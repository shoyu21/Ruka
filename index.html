<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REINA v12.1 – Quick Mode</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0e7490;
            --primary-dark: #0a5a6e;
            --primary-light: #67e8f9;
            --primary-wash: #ecfeff;
            --accent: #6366f1;
            --accent-wash: #eef2ff;
            --success: #059669;
            --success-wash: #ecfdf5;
            --warning: #d97706;
            --warning-wash: #fffbeb;
            --danger: #dc2626;
            --danger-wash: #fef2f2;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #0f172a;
            --text-mid: #475569;
            --text-light: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --radius: 14px;
            --radius-sm: 8px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06), 0 2px 4px rgba(0,0,0,0.04);
            --shadow-lg: 0 12px 32px rgba(0,0,0,0.08), 0 4px 8px rgba(0,0,0,0.04);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* — LAYOUT — */
        .app {
            max-width: 860px;
            margin: 0 auto;
            padding: 24px 20px 80px;
        }

        /* — HEADER — */
        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .header-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .header-badge .dot {
            width: 6px;
            height: 6px;
            background: var(--primary-light);
            border-radius: 50%;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
            letter-spacing: -0.5px;
            margin-bottom: 6px;
        }

        .header p {
            color: var(--text-mid);
            font-size: 15px;
            max-width: 520px;
            margin: 0 auto;
        }

        /* — PROGRESS — */
        .progress-bar {
            display: flex;
            align-items: center;
            gap: 0;
            margin-bottom: 32px;
            padding: 0 8px;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .progress-step .num {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            background: var(--border);
            color: var(--text-light);
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .progress-step.active .num {
            background: var(--primary);
            color: white;
            box-shadow: 0 0 0 4px rgba(14, 116, 144, 0.15);
        }

        .progress-step.done .num {
            background: var(--success);
            color: white;
        }

        .progress-step .label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-light);
            white-space: nowrap;
            transition: all 0.3s;
        }

        .progress-step.active .label {
            color: var(--primary);
            font-weight: 600;
        }

        .progress-step.done .label {
            color: var(--success);
        }

        .progress-line {
            flex: 1;
            height: 2px;
            background: var(--border);
            margin: 0 6px;
            transition: background 0.3s;
        }

        .progress-line.done {
            background: var(--success);
        }

        /* — STEP PANELS — */
        .step-panel {
            display: none;
            animation: fadeUp 0.35s ease;
        }

        .step-panel.active {
            display: block;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-question {
            font-size: 22px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 6px;
            letter-spacing: -0.3px;
        }

        .step-subtitle {
            font-size: 14px;
            color: var(--text-mid);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        /* — CHOICE CARDS — */
        .choice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .choice-grid.single-col {
            grid-template-columns: 1fr;
        }

        .choice-grid.triple {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .choice-card {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 18px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .choice-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .choice-card.selected {
            border-color: var(--primary);
            background: var(--primary-wash);
            box-shadow: 0 0 0 3px rgba(14, 116, 144, 0.12);
        }

        .choice-card.urgent {
            border-left: 4px solid var(--danger);
        }

        .choice-card.urgent.selected {
            background: var(--danger-wash);
            border-color: var(--danger);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .choice-card .icon {
            font-size: 22px;
            margin-bottom: 8px;
        }

        .choice-card .title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .choice-card .desc {
            font-size: 12px;
            color: var(--text-mid);
            line-height: 1.4;
        }

        .choice-card .check {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: transparent;
            transition: all 0.2s;
        }

        .choice-card.selected .check {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .choice-card.urgent.selected .check {
            background: var(--danger);
            border-color: var(--danger);
        }

        /* — SECTION DIVIDER — */
        .section-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-light);
            margin: 24px 0 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        /* — WEIGHT SELECTOR — */
        .weight-selector {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .weight-option {
            flex: 1;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 20px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .weight-option:hover {
            border-color: var(--primary);
        }

        .weight-option.selected {
            border-color: var(--primary);
            background: var(--primary-wash);
            box-shadow: 0 0 0 3px rgba(14, 116, 144, 0.12);
        }

        .weight-option .range {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
        }

        .weight-option .unit {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .weight-exact {
            margin-top: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .weight-exact label {
            font-size: 13px;
            color: var(--text-mid);
            white-space: nowrap;
        }

        .weight-exact input {
            width: 100px;
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            text-align: center;
            outline: none;
            transition: border 0.2s;
        }

        .weight-exact input:focus {
            border-color: var(--primary);
        }

        .weight-exact .suffix {
            font-size: 13px;
            color: var(--text-light);
        }

        /* — NAV BUTTONS — */
        .nav-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 22px;
            border-radius: var(--radius-sm);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-back {
            background: transparent;
            color: var(--text-mid);
        }

        .btn-back:hover {
            color: var(--text);
            background: var(--border-light);
        }

        .btn-next {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-next:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-next:disabled {
            background: var(--border);
            color: var(--text-light);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-generate {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            padding: 12px 28px;
            font-size: 15px;
            box-shadow: var(--shadow-md);
        }

        .btn-generate:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .selection-count {
            font-size: 12px;
            color: var(--text-light);
        }

        /* — OUTPUT PANEL — */
        .output-panel {
            display: none;
            animation: fadeUp 0.4s ease;
        }

        .output-panel.active {
            display: block;
        }

        .rx-card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .rx-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px 24px;
        }

        .rx-header h2 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .rx-header .subtitle {
            font-size: 13px;
            opacity: 0.85;
        }

        .rx-body {
            padding: 24px;
        }

        /* — SETTINGS GRID (from dosing_adjustment.html) — */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .setting-item {
            background: var(--bg);
            padding: 12px;
            border-radius: var(--radius-sm);
            text-align: center;
            border: 1px solid var(--border-light);
        }

        .setting-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 4px;
        }

        .setting-value {
            font-size: 17px;
            font-weight: 700;
            color: var(--primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .setting-unit {
            font-size: 10px;
            font-weight: normal;
            color: var(--text-light);
        }

        .setting-why {
            font-size: 9px;
            color: var(--success);
            margin-top: 3px;
            font-style: italic;
            line-height: 1.3;
        }

        .setting-item.span-2 {
            grid-column: span 2;
        }

        /* — PROTOCOL NOTE — */
        .protocol-note {
            margin-top: 12px;
            padding: 10px 14px;
            background: #f0f9ff;
            border-radius: var(--radius-sm);
            font-size: 11px;
            color: #0369a1;
            border-left: 3px solid #0ea5e9;
            line-height: 1.5;
        }

        /* — CITRATE SECTION — */
        .citrate-section {
            background: var(--card);
            border: 1px solid #fde68a;
            border-left: 4px solid var(--warning);
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-bottom: 16px;
        }

        .citrate-section h3 {
            font-size: 14px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 10px;
        }

        .citrate-section .detail {
            font-size: 12px;
            color: var(--text-mid);
            line-height: 1.6;
        }

        /* — PROTOCOL TABLE — */
        .protocol-table-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .protocol-table-section h3 {
            font-size: 13px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .protocol-table-section .table-note {
            font-size: 10px;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .protocol-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .protocol-table th,
        .protocol-table td {
            padding: 8px 10px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .protocol-table th {
            background: var(--bg);
            font-weight: 600;
            font-size: 11px;
            color: var(--text-mid);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .protocol-table th.header-row {
            background: var(--primary-wash);
            color: var(--primary);
            text-transform: none;
            font-size: 12px;
        }

        .protocol-table tr:last-child td {
            border-bottom: none;
        }

        .protocol-table td.active-weight {
            background: var(--primary-wash);
            font-weight: 700;
            color: var(--primary);
        }

        /* — DOSE TRANSPARENCY — */
        .dose-section {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
        }

        .dose-section h3 {
            font-size: 14px;
            font-weight: 700;
            color: #065f46;
            margin-bottom: 12px;
        }

        .dose-transparency-box {
            background: white;
            border-radius: var(--radius-sm);
            padding: 14px;
            margin-bottom: 14px;
        }

        .dose-transparency-box .formula {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
            margin: 8px 0;
            color: var(--text);
            border-left: 3px solid var(--primary);
        }

        .dose-transparency-box .explanation {
            font-size: 11px;
            color: var(--text-mid);
            margin-top: 8px;
            line-height: 1.5;
        }

        /* — DOSE LIVE CALC — */
        .dose-live-calc {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 12px;
            align-items: center;
            background: white;
            padding: 14px;
            border-radius: var(--radius-sm);
        }

        .dose-live-box {
            text-align: center;
            padding: 8px;
        }

        .dose-live-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 4px;
        }

        .dose-live-value {
            font-size: 24px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .dose-live-value.prescribed { color: var(--primary); }
        .dose-live-value.delivered { color: var(--success); }
        .dose-live-value.delivered.warning-val { color: #f59e0b; }
        .dose-live-value.delivered.danger-val { color: #ef4444; }

        .dose-arrow {
            font-size: 24px;
            color: var(--text-light);
        }

        .dose-unit {
            font-size: 10px;
            font-weight: normal;
        }

        .dose-status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 6px;
        }

        .dose-status-badge.optimal {
            background: #d1fae5;
            color: #065f46;
        }

        .dose-status-badge.suboptimal {
            background: #fef3c7;
            color: #92400e;
        }

        .dose-status-badge.low {
            background: #fecaca;
            color: #991b1b;
        }

        /* — UF RECOMMENDATION — */
        .uf-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .uf-section h3 {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .uf-section .detail {
            font-size: 12px;
            color: var(--text-mid);
            line-height: 1.6;
        }

        .uf-section.conservative { border-left: 4px solid var(--danger); }
        .uf-section.moderate { border-left: 4px solid var(--warning); }
        .uf-section.liberal { border-left: 4px solid var(--success); }

        /* — SEPSIS EVIDENCE — */
        .sepsis-section {
            background: linear-gradient(135deg, #faf5ff, #f3e8ff);
            border: 2px solid #c4b5fd;
            border-radius: var(--radius);
            padding: 16px 20px;
            margin-bottom: 16px;
        }

        .sepsis-section h3 {
            font-size: 13px;
            font-weight: 700;
            color: #7c3aed;
            margin-bottom: 8px;
        }

        .sepsis-section .detail {
            font-size: 12px;
            color: #6b21a8;
            line-height: 1.6;
        }

        /* — EVIDENCE BOX — */
        .evidence-box {
            background: #dbeafe;
            border-radius: var(--radius-sm);
            padding: 14px 16px;
            margin-bottom: 16px;
            font-size: 12px;
            color: #1e40af;
            line-height: 1.6;
        }

        .evidence-box strong {
            display: block;
            margin-bottom: 6px;
        }

        /* — CLINICAL PROMPTS — */
        .clinical-prompts {
            background: #fff7ed;
            border: 1px solid #fed7aa;
            border-radius: var(--radius-sm);
            padding: 14px 16px;
            margin-bottom: 16px;
        }

        .clinical-prompts h4 {
            font-size: 12px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 8px;
        }

        .clinical-prompts ul {
            margin: 0;
            padding-left: 18px;
            font-size: 11px;
            color: #78350f;
            line-height: 1.6;
        }

        .clinical-prompts li {
            margin-bottom: 3px;
        }

        /* — EXISTING OUTPUT STYLES — */
        .rx-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .rx-item {
            padding: 14px 16px;
            background: var(--bg);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--primary);
        }

        .rx-item.highlight {
            border-left-color: var(--accent);
            background: var(--accent-wash);
        }

        .rx-item.warning {
            border-left-color: var(--warning);
            background: var(--warning-wash);
        }

        .rx-item .rx-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .rx-item .rx-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
        }

        .rx-item .rx-note {
            font-size: 11px;
            color: var(--text-mid);
            margin-top: 4px;
            line-height: 1.4;
        }

        .rx-full {
            grid-column: 1 / -1;
        }

        /* Clinical reasoning card */
        .reasoning-card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            margin-bottom: 16px;
        }

        .reasoning-header {
            padding: 14px 20px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reasoning-body {
            padding: 16px 20px;
        }

        .reasoning-item {
            display: flex;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
            font-size: 13px;
            color: var(--text-mid);
            line-height: 1.5;
        }

        .reasoning-item:last-child {
            border-bottom: none;
        }

        .reasoning-item .r-icon {
            flex-shrink: 0;
            margin-top: 2px;
        }

        .reasoning-item strong {
            color: var(--text);
        }

        .evidence-pill {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 4px;
        }

        /* — SELECTIONS SUMMARY — */
        .summary-strip {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 20px;
        }

        .summary-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--primary-wash);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .summary-tag.danger {
            background: var(--danger-wash);
            color: var(--danger);
        }

        .summary-tag.warning {
            background: var(--warning-wash);
            color: var(--warning);
        }

        /* — MODE TOGGLE — */
        .mode-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 28px;
        }

        .mode-toggle-inner {
            display: flex;
            background: var(--card);
            border-radius: 10px;
            padding: 4px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }

        .mode-btn {
            padding: 8px 20px;
            border-radius: 7px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            color: var(--text-mid);
            font-family: 'DM Sans', sans-serif;
        }

        .mode-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        /* — COMPARISON STRIP — */
        .comparison {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px 24px;
            margin-top: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }

        .comparison h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text);
        }

        .compare-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 16px;
            align-items: start;
        }

        .compare-col {
            font-size: 13px;
            line-height: 1.6;
        }

        .compare-col h4 {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .compare-arrow {
            font-size: 20px;
            color: var(--primary);
            padding-top: 24px;
        }

        .compare-col ul {
            list-style: none;
            padding: 0;
        }

        .compare-col li {
            padding: 3px 0;
            color: var(--text-mid);
        }

        .compare-col li::before {
            content: '\2022';
            color: var(--text-light);
            margin-right: 8px;
        }

        .compare-col.new li::before {
            content: '\2714';
            color: var(--success);
        }

        /* — RESPONSIVE — */
        @media (max-width: 640px) {
            .choice-grid { grid-template-columns: 1fr; }
            .choice-grid.triple { grid-template-columns: 1fr; }
            .rx-grid { grid-template-columns: 1fr; }
            .settings-grid { grid-template-columns: repeat(2, 1fr); }
            .compare-row { grid-template-columns: 1fr; gap: 12px; }
            .compare-arrow { display: none; }
            .progress-step .label { display: none; }
            .weight-selector { flex-direction: column; }
            .dose-live-calc { grid-template-columns: 1fr; gap: 8px; }
            .dose-arrow { transform: rotate(90deg); }
        }

        /* — WIREFRAME NOTICE — */
        .wireframe-notice {
            text-align: center;
            padding: 10px;
            background: #fef3c7;
            color: #92400e;
            font-size: 12px;
            font-weight: 500;
            border-bottom: 1px solid #fde68a;
        }

        /* — RESTART — */
        .btn-restart {
            background: var(--bg);
            color: var(--text-mid);
            border: 1px solid var(--border);
            margin-top: 12px;
        }

        .btn-restart:hover {
            background: var(--border-light);
            border-color: var(--text-light);
        }

        /* — PROMPT CARD — */
        .prompt-card {
            background: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: var(--radius-sm);
            padding: 12px 16px;
            margin-top: 16px;
            font-size: 12px;
            color: #92400e;
            line-height: 1.5;
        }

        .prompt-card strong {
            display: block;
            margin-bottom: 4px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>

<div class="wireframe-notice">
    REINA v12 – Quick Mode Wireframe / Interactive Prototype (for clinician feedback)
</div>

<div class="app">

    <!-- HEADER -->
    <div class="header">
        <div class="header-badge">
            <span>REINA v12</span>
            <span class="dot"></span>
            <span>QUICK MODE</span>
        </div>
        <h1>Goal-Directed RRT Prescription</h1>
        <p>5 clinical choices → personalised CRRT prescription. No data entry required.</p>
    </div>

    <!-- MODE TOGGLE -->
    <div class="mode-toggle">
        <div class="mode-toggle-inner">
            <button class="mode-btn active" onclick="showQuickMode()">&#9889; Quick Mode</button>
            <button class="mode-btn" onclick="showDetailedMode()">&#128203; Detailed Mode</button>
        </div>
    </div>

    <!-- PROGRESS BAR -->
    <div class="progress-bar" id="progressBar">
        <div class="progress-step active" data-step="1" onclick="goToStep(1)">
            <div class="num">1</div>
            <div class="label">Indication</div>
        </div>
        <div class="progress-line" id="line1"></div>
        <div class="progress-step" data-step="2" onclick="goToStep(2)">
            <div class="num">2</div>
            <div class="label">Haemodynamics</div>
        </div>
        <div class="progress-line" id="line2"></div>
        <div class="progress-step" data-step="3" onclick="goToStep(3)">
            <div class="num">3</div>
            <div class="label">Bleeding Risk</div>
        </div>
        <div class="progress-line" id="line3"></div>
        <div class="progress-step" data-step="4" onclick="goToStep(4)">
            <div class="num">4</div>
            <div class="label">Context</div>
        </div>
        <div class="progress-line" id="line4"></div>
        <div class="progress-step" data-step="5" onclick="goToStep(5)">
            <div class="num">5</div>
            <div class="label">Weight</div>
        </div>
    </div>

    <!-- ═══════════════════════════════════ -->
    <!-- STEP 1: WHY RRT? -->
    <!-- ═══════════════════════════════════ -->
    <div class="step-panel active" id="step1">
        <div class="step-question">Why are you starting RRT?</div>
        <div class="step-subtitle">Select all that apply. This drives urgency assessment and modality selection.</div>

        <div class="section-label">Emergency Indications (Tier 1)</div>
        <div class="choice-grid">
            <div class="choice-card urgent" onclick="toggleChoice(this, 'indication')" data-value="refractory-k">
                <div class="check">&#10003;</div>
                <div class="title">Refractory Hyperkalaemia</div>
                <div class="desc">K&#8314; not responding to medical therapy</div>
            </div>
            <div class="choice-card urgent" onclick="toggleChoice(this, 'indication')" data-value="severe-acidosis">
                <div class="check">&#10003;</div>
                <div class="title">Severe Metabolic Acidosis</div>
                <div class="desc">pH &lt;7.1, ventilation not compensating</div>
            </div>
            <div class="choice-card urgent" onclick="toggleChoice(this, 'indication')" data-value="pulm-edema">
                <div class="check">&#10003;</div>
                <div class="title">Refractory Pulmonary Oedema</div>
                <div class="desc">Diuretic-resistant, worsening oxygenation</div>
            </div>
            <div class="choice-card urgent" onclick="toggleChoice(this, 'indication')" data-value="uraemic">
                <div class="check">&#10003;</div>
                <div class="title">Uraemic Complications</div>
                <div class="desc">Encephalopathy, pericarditis, bleeding</div>
            </div>
            <div class="choice-card urgent" onclick="toggleChoice(this, 'indication')" data-value="toxin">
                <div class="check">&#10003;</div>
                <div class="title">Toxin / Overdose Removal</div>
                <div class="desc">Dialysable toxin per EXTRIP guidelines</div>
            </div>
        </div>

        <div class="section-label">Treatment Goals (Tier 2)</div>
        <div class="choice-grid">
            <div class="choice-card" onclick="toggleChoice(this, 'indication')" data-value="volume">
                <div class="check">&#10003;</div>
                <div class="title">Volume Management</div>
                <div class="desc">Fluid overload, diuretic-resistant or intolerant</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'indication')" data-value="acidosis-correction">
                <div class="check">&#10003;</div>
                <div class="title">Acidosis Correction</div>
                <div class="desc">Buffer delivery, permissive bicarb management</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'indication')" data-value="electrolyte">
                <div class="check">&#10003;</div>
                <div class="title">Electrolyte Control</div>
                <div class="desc">K&#8314;, Na&#8314;, PO&#8324; management beyond standard Rx</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'indication')" data-value="solute-clearance">
                <div class="check">&#10003;</div>
                <div class="title">Solute Clearance</div>
                <div class="desc">Uraemia, supportive clearance in AKI</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'indication')" data-value="enable-nutrition">
                <div class="check">&#10003;</div>
                <div class="title">Enable Nutrition / Medications</div>
                <div class="desc">Create fluid space for feeds, antibiotics, blood products</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'indication')" data-value="temp-mgmt">
                <div class="check">&#10003;</div>
                <div class="title">Temperature Management</div>
                <div class="desc">Refractory hyperthermia, targeted temperature</div>
            </div>
        </div>

        <div class="nav-row">
            <div class="selection-count" id="step1Count">No selections yet</div>
            <button class="btn btn-next" id="step1Next" disabled onclick="nextStep()">Continue &#8594;</button>
        </div>
    </div>

    <!-- ═══════════════════════════════════ -->
    <!-- STEP 2: HAEMODYNAMIC STATE -->
    <!-- ═══════════════════════════════════ -->
    <div class="step-panel" id="step2">
        <div class="step-question">What's the haemodynamic picture?</div>
        <div class="step-subtitle">This determines modality preference and fluid removal tolerance. Select the best fit.</div>

        <div class="choice-grid single-col">
            <div class="choice-card" onclick="selectSingle(this, 'haemo')" data-value="stable">
                <div class="check">&#10003;</div>
                <div class="icon">&#128994;</div>
                <div class="title">Haemodynamically Stable</div>
                <div class="desc">No vasopressors, stable MAP. Tolerates fluid shifts. May be suitable for IHD if access available.</div>
            </div>
            <div class="choice-card" onclick="selectSingle(this, 'haemo')" data-value="stable-pressors">
                <div class="check">&#10003;</div>
                <div class="icon">&#128992;</div>
                <div class="title">Stable on Low-Dose Vasopressors</div>
                <div class="desc">NAd &#8804;0.1 &#181;g/kg/min or equivalent. Stable trend. Can tolerate gentle UF. CRRT preferred.</div>
            </div>
            <div class="choice-card" onclick="selectSingle(this, 'haemo')" data-value="unstable-distributive">
                <div class="check">&#10003;</div>
                <div class="icon">&#128308;</div>
                <div class="title">Distributive Shock (Sepsis / Vasodilatory)</div>
                <div class="desc">Escalating vasopressors, warm peripheries, high cardiac output, low SVR. Septic, anaphylactic, or neurogenic.</div>
            </div>
            <div class="choice-card" onclick="selectSingle(this, 'haemo')" data-value="unstable-cardiogenic">
                <div class="check">&#10003;</div>
                <div class="icon">&#128308;</div>
                <div class="title">Cardiogenic Shock</div>
                <div class="desc">Low CO, elevated filling pressures, cool peripheries. Consider SCUF for volume. Very cautious UF rates.</div>
            </div>
            <div class="choice-card" onclick="selectSingle(this, 'haemo')" data-value="mixed">
                <div class="check">&#10003;</div>
                <div class="icon">&#128992;</div>
                <div class="title">Mixed / Evolving Shock</div>
                <div class="desc">Components of multiple shock types or unclear. Haemodynamics fluctuating. Reassess frequently.</div>
            </div>
        </div>

        <div class="prompt-card">
            <strong>&#129504; Clinical Thinking Prompt</strong>
            If your patient is on multiple vasopressors or on ECMO, consider whether UF goals should be deferred.
            Ross Prager: "Define the haemodynamic phenotype before writing the prescription."
        </div>

        <div class="nav-row">
            <button class="btn btn-back" onclick="prevStep()">&#8592; Back</button>
            <button class="btn btn-next" id="step2Next" disabled onclick="nextStep()">Continue &#8594;</button>
        </div>
    </div>

    <!-- ═══════════════════════════════════ -->
    <!-- STEP 3: BLEEDING RISK -->
    <!-- ═══════════════════════════════════ -->
    <div class="step-panel" id="step3">
        <div class="step-question">What's the bleeding risk?</div>
        <div class="step-subtitle">This drives anticoagulation strategy. Select the primary concern.</div>

        <div class="choice-grid single-col">
            <div class="choice-card" onclick="selectSingle(this, 'bleeding')" data-value="low">
                <div class="check">&#10003;</div>
                <div class="title">&#128994; Low Bleeding Risk</div>
                <div class="desc">No active bleeding, no recent surgery, adequate platelets, normal coagulation. Standard anticoagulation options available.</div>
            </div>
            <div class="choice-card" onclick="selectSingle(this, 'bleeding')" data-value="moderate">
                <div class="check">&#10003;</div>
                <div class="title">&#128992; Moderate Bleeding Risk</div>
                <div class="desc">Recent surgery (48-72h), mild coagulopathy, thrombocytopaenia (50-100), therapeutic anticoagulation for other indication.</div>
            </div>
            <div class="choice-card" onclick="selectSingle(this, 'bleeding')" data-value="high">
                <div class="check">&#10003;</div>
                <div class="title">&#128308; High Bleeding Risk</div>
                <div class="desc">Active bleeding, DIC, severe thrombocytopaenia (&lt;50), recent major surgery (&lt;48h), intracranial pathology.</div>
            </div>
            <div class="choice-card" onclick="selectSingle(this, 'bleeding')" data-value="hit">
                <div class="check">&#10003;</div>
                <div class="title">&#9888;&#65039; HIT Confirmed / Suspected</div>
                <div class="desc">Heparin-induced thrombocytopaenia. All heparin products contraindicated. Requires alternative anticoagulation.</div>
            </div>
            <div class="choice-card" onclick="selectSingle(this, 'bleeding')" data-value="liver-failure">
                <div class="check">&#10003;</div>
                <div class="title">&#128992; Liver Failure / Coagulopathy</div>
                <div class="desc">Hepatic dysfunction with impaired citrate metabolism. INR elevated due to synthetic failure. Citrate requires close monitoring.</div>
            </div>
        </div>

        <div class="nav-row">
            <button class="btn btn-back" onclick="prevStep()">&#8592; Back</button>
            <button class="btn btn-next" id="step3Next" disabled onclick="nextStep()">Continue &#8594;</button>
        </div>
    </div>

    <!-- ═══════════════════════════════════ -->
    <!-- STEP 4: CLINICAL CONTEXT -->
    <!-- ═══════════════════════════════════ -->
    <div class="step-panel" id="step4">
        <div class="step-question">Any special clinical context?</div>
        <div class="step-subtitle">Select any that apply. These modify the base prescription. Skip if none.</div>

        <div class="choice-grid">
            <div class="choice-card" onclick="toggleChoice(this, 'context')" data-value="brain-injury">
                <div class="check">&#10003;</div>
                <div class="title">&#129504; Brain Injury / Raised ICP</div>
                <div class="desc">Avoid rapid osmolality shifts, target Na&#8314; stability</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'context')" data-value="ecmo">
                <div class="check">&#10003;</div>
                <div class="title">&#128260; On ECMO</div>
                <div class="desc">Circuit integration considerations, shared anticoagulation</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'context')" data-value="post-cardiac">
                <div class="check">&#10003;</div>
                <div class="title">&#129728; Post-Cardiac Surgery</div>
                <div class="desc">Inflammatory response, volume sensitivity, mediastinal bleeding risk</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'context')" data-value="rhabdo">
                <div class="check">&#10003;</div>
                <div class="title">&#128170; Rhabdomyolysis</div>
                <div class="desc">High solute load, may need higher clearance, watch for hyperkalaemia</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'context')" data-value="tls">
                <div class="check">&#10003;</div>
                <div class="title">&#129516; Tumour Lysis Syndrome</div>
                <div class="desc">Uric acid, PO&#8324;, K&#8314; surge. High-intensity CRRT may be needed</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'context')" data-value="dysnatemia">
                <div class="check">&#10003;</div>
                <div class="title">&#129514; Significant Dysnatraemia</div>
                <div class="desc">Na&#8314; &lt;125 or &gt;155. Custom dialysate/replacement to control correction rate</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'context')" data-value="pregnancy">
                <div class="check">&#10003;</div>
                <div class="title">&#129328; Pregnancy</div>
                <div class="desc">Adjusted dosing, electrolyte targets, fetal considerations</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'context')" data-value="circuit-issues">
                <div class="check">&#10003;</div>
                <div class="title">&#128260; Recurrent Circuit Clotting</div>
                <div class="desc">Already on CRRT with frequent early filter loss. Re-evaluate anticoagulation.</div>
            </div>
        </div>

        <div class="nav-row">
            <button class="btn btn-back" onclick="prevStep()">&#8592; Back</button>
            <button class="btn btn-next" onclick="nextStep()">Continue &#8594;</button>
        </div>
    </div>

    <!-- ═══════════════════════════════════ -->
    <!-- STEP 5: WEIGHT -->
    <!-- ═══════════════════════════════════ -->
    <div class="step-panel" id="step5">
        <div class="step-question">Patient weight</div>
        <div class="step-subtitle">Required for dose calculation (ml/kg/hr). Choose a range or enter exact weight.</div>

        <div class="weight-selector">
            <div class="weight-option" onclick="selectWeight(this, 'lt60')" data-value="lt60">
                <div class="range">&lt;60</div>
                <div class="unit">kg</div>
            </div>
            <div class="weight-option" onclick="selectWeight(this, '60-75')" data-value="60-75">
                <div class="range">60–75</div>
                <div class="unit">kg</div>
            </div>
            <div class="weight-option" onclick="selectWeight(this, 'gt75')" data-value="gt75">
                <div class="range">&gt;75</div>
                <div class="unit">kg</div>
            </div>
        </div>

        <div class="weight-exact">
            <label>Or enter exact:</label>
            <input type="number" id="exactWeight" placeholder="70" min="30" max="200" oninput="onExactWeight()">
            <span class="suffix">kg</span>
        </div>

        <div class="prompt-card">
            <strong>&#128161; Weight &amp; Dosing Bands</strong>
            Protocol uses 3 weight bands: &lt;60 kg, 60\u201375 kg, &gt;75 kg. Patients at exactly 60 or 75 kg fall into the 60\u201375 band.<br>
            Use <strong>actual body weight</strong> for most patients. For morbidly obese (BMI &gt;40), consider adjusted body weight.<br>
            Protocols are designed for patients up to 100 kg. For &gt;100 kg, a customised prescription may be needed.
        </div>

        <div class="nav-row">
            <button class="btn btn-back" onclick="prevStep()">&#8592; Back</button>
            <button class="btn btn-generate" onclick="safeGeneratePrescription()">Generate Prescription &#8594;</button>
        </div>
    </div>

    <!-- ═══════════════════════════════════ -->
    <!-- OUTPUT -->
    <!-- ═══════════════════════════════════ -->
    <div class="output-panel" id="outputPanel">

        <div class="step-question" style="margin-bottom: 16px;">Your CRRT Prescription</div>

        <!-- Summary of selections -->
        <div class="summary-strip" id="summaryStrip"></div>

        <!-- Main Rx Card with Settings Grid -->
        <div class="rx-card">
            <div class="rx-header">
                <h2 id="rxTitle">CVVHDF – Citrate Anticoagulation</h2>
                <div class="subtitle" id="rxSubtitle">Goal-directed prescription based on 5 clinical selections</div>
            </div>
            <div class="rx-body">
                <div class="settings-grid" id="settingsGrid">
                    <!-- Populated by JS -->
                </div>
                <div id="protocolNote"></div>
            </div>
        </div>

        <!-- Citrate Protocol (conditional) -->
        <div id="citrateSection"></div>

        <!-- Dose Transparency -->
        <div id="doseSection"></div>

        <!-- UF Recommendation -->
        <div id="ufSection"></div>

        <!-- Monitoring Section -->
        <div id="monitoringSection"></div>

        <!-- Sepsis Evidence (conditional) -->
        <div id="sepsisSection"></div>

        <!-- MICU Protocol Reference Table -->
        <div id="protocolTableSection"></div>

        <!-- Clinical Prompts (conditional) -->
        <div id="clinicalPrompts"></div>

        <!-- Key Evidence -->
        <div id="evidenceBox"></div>

        <!-- Clinical Reasoning -->
        <div class="reasoning-card">
            <div class="reasoning-header">&#129504; Clinical Reasoning – Why This Prescription?</div>
            <div class="reasoning-body" id="reasoningBody">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Evidence Card -->
        <div class="reasoning-card">
            <div class="reasoning-header">&#128218; Evidence Base</div>
            <div class="reasoning-body" id="evidenceBody">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Context-specific warnings -->
        <div id="contextWarnings"></div>

        <div style="text-align: center; margin-top: 24px;">
            <button class="btn btn-restart" onclick="restart()">&#8592; Start Over</button>
            <button class="btn btn-next" style="margin-left: 8px;" onclick="alert('In v12, this would switch to Detailed Mode with all fields pre-populated from your Quick Mode selections.')">Refine in Detailed Mode &#8594;</button>
        </div>
    </div>

    <!-- COMPARISON -->
    <div class="comparison" id="comparison">
        <h3>v11 (Current) → v12 Quick Mode (Proposed)</h3>
        <div class="compare-row">
            <div class="compare-col">
                <h4>v11 – Data Entry</h4>
                <ul>
                    <li>Enter K&#8314;, pH, UO, urea values</li>
                    <li>Select AKI stage &amp; duration</li>
                    <li>Enter platelets, INR, APTT</li>
                    <li>Enter haemodynamics, POCUS</li>
                    <li>Select conditions (10 buttons)</li>
                    <li>Adjust dose sliders</li>
                    <li>~15-20 fields to complete</li>
                </ul>
            </div>
            <div class="compare-arrow">→</div>
            <div class="compare-col new">
                <h4>v12 – Clinical Choices</h4>
                <ul>
                    <li>Tap indication(s) – why RRT?</li>
                    <li>Tap haemodynamic state</li>
                    <li>Tap bleeding risk level</li>
                    <li>Tap special contexts (optional)</li>
                    <li>Weight (range or exact)</li>
                    <li>5 taps → full prescription</li>
                    <li>"Refine in Detailed Mode" bridge</li>
                </ul>
            </div>
        </div>
    </div>

</div>

<script>
    // ═══════════════════════════════════
    // STATE
    // ═══════════════════════════════════
    let currentStep = 1;
    const totalSteps = 5;

    const selections = {
        indication: new Set(),
        haemo: null,
        bleeding: null,
        context: new Set(),
        weight: null,
        exactWeight: null
    };

    // ═══════════════════════════════════
    // MULTI-SELECT (indication, context)
    // ═══════════════════════════════════
    function toggleChoice(card, group) {
        const value = card.dataset.value;
        card.classList.toggle('selected');

        if (selections[group].has(value)) {
            selections[group].delete(value);
        } else {
            selections[group].add(value);
        }

        updateCounts();
        updateNavButtons();
    }

    // ═══════════════════════════════════
    // SINGLE-SELECT (haemo, bleeding)
    // ═══════════════════════════════════
    function selectSingle(card, group) {
        const panel = card.closest('.step-panel');
        panel.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        selections[group] = card.dataset.value;
        updateNavButtons();
    }

    // ═══════════════════════════════════
    // WEIGHT
    // ═══════════════════════════════════
    function selectWeight(el, value) {
        document.querySelectorAll('.weight-option').forEach(w => w.classList.remove('selected'));
        el.classList.add('selected');
        selections.weight = value;
        document.getElementById('exactWeight').value = '';
        selections.exactWeight = null;
    }

    function onExactWeight() {
        const val = document.getElementById('exactWeight').value;
        if (val) {
            document.querySelectorAll('.weight-option').forEach(w => w.classList.remove('selected'));
            selections.exactWeight = parseFloat(val);
            selections.weight = val < 60 ? 'lt60' : val <= 75 ? '60-75' : 'gt75';
        }
    }

    // ═══════════════════════════════════
    // NAVIGATION
    // ═══════════════════════════════════
    function nextStep() {
        if (currentStep < totalSteps) {
            currentStep++;
            renderStep();
        }
    }

    function prevStep() {
        if (currentStep > 1) {
            currentStep--;
            renderStep();
        }
    }

    function goToStep(n) {
        if (n <= currentStep || n <= getMaxAllowedStep()) {
            currentStep = n;
            renderStep();
        }
    }

    function getMaxAllowedStep() {
        return totalSteps;
    }

    function renderStep() {
        document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
        document.getElementById(`step${currentStep}`).classList.add('active');
        document.getElementById('outputPanel').classList.remove('active');

        document.querySelectorAll('.progress-step').forEach(s => {
            const step = parseInt(s.dataset.step);
            s.classList.remove('active', 'done');
            if (step === currentStep) s.classList.add('active');
            else if (step < currentStep) s.classList.add('done');
        });

        for (let i = 1; i < totalSteps; i++) {
            const line = document.getElementById(`line${i}`);
            line.classList.toggle('done', i < currentStep);
        }

        updateNavButtons();
    }

    function updateNavButtons() {
        const btn1 = document.getElementById('step1Next');
        const btn2 = document.getElementById('step2Next');
        const btn3 = document.getElementById('step3Next');

        if (btn1) btn1.disabled = selections.indication.size === 0;
        if (btn2) btn2.disabled = !selections.haemo;
        if (btn3) btn3.disabled = !selections.bleeding;
    }

    function updateCounts() {
        const count1 = document.getElementById('step1Count');
        if (count1) {
            const n = selections.indication.size;
            count1.textContent = n === 0 ? 'No selections yet' : `${n} indication${n > 1 ? 's' : ''} selected`;
        }
    }

    function restart() {
        currentStep = 1;
        selections.indication.clear();
        selections.haemo = null;
        selections.bleeding = null;
        selections.context.clear();
        selections.weight = null;
        selections.exactWeight = null;

        document.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected'));
        document.querySelectorAll('.weight-option').forEach(w => w.classList.remove('selected'));
        document.getElementById('exactWeight').value = '';

        renderStep();
    }

    // ═══════════════════════════════════
    // ERROR TRAP — Shows errors visually if prescription generation fails
    // ═══════════════════════════════════
    function safeGeneratePrescription() {
        try {
            generatePrescription();
        } catch(e) {
            // Show error panel
            document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
            const output = document.getElementById('outputPanel');
            output.classList.add('active');
            output.innerHTML = `
                <div style="padding: 32px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 16px;">\u26A0\uFE0F</div>
                    <h2 style="color: #dc2626; margin-bottom: 12px;">Prescription Generation Error</h2>
                    <p style="color: #475569; margin-bottom: 20px;">Something went wrong. The error details are below. Please share this with the developer.</p>
                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px; text-align: left; font-family: 'JetBrains Mono', monospace; font-size: 12px; color: #991b1b; white-space: pre-wrap; word-break: break-word;">
<strong>Error:</strong> ${e.message}

<strong>Location:</strong> ${e.stack ? e.stack.split('\\n').slice(0,4).join('\\n') : 'Unknown'}

<strong>Selections at time of error:</strong>
Indications: ${[...selections.indication].join(', ') || 'none'}
Haemodynamics: ${selections.haemo || 'none'}
Bleeding: ${selections.bleeding || 'none'}
Context: ${[...selections.context].join(', ') || 'none'}
Weight: ${selections.exactWeight || selections.weight || 'none'}
                    </div>
                    <button onclick="restart()" class="btn btn-next" style="margin-top: 20px;">&#8592; Start Over</button>
                </div>`;
            // Also log to console for DevTools debugging
            console.error('REINA generatePrescription() error:', e);
        }
    }

    // ═══════════════════════════════════
    // GENERATE PRESCRIPTION
    // ═══════════════════════════════════
    function generatePrescription() {
        // Hide steps, show output
        document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
        document.getElementById('outputPanel').classList.add('active');

        // Mark all progress done
        document.querySelectorAll('.progress-step').forEach(s => s.classList.add('done'));
        document.querySelectorAll('.progress-step').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.progress-line').forEach(l => l.classList.add('done'));

        // === CLINICAL CONTEXT FLAGS ===
        const hasEmergency = ['refractory-k', 'severe-acidosis', 'pulm-edema', 'uraemic', 'toxin']
            .some(e => selections.indication.has(e));
        const isDistributive = selections.haemo === 'unstable-distributive';
        const isCardiogenic = selections.haemo === 'unstable-cardiogenic';
        const highBleed = selections.bleeding === 'high';
        const isHIT = selections.bleeding === 'hit';
        const liverFail = selections.bleeding === 'liver-failure';
        const hasBrainInjury = selections.context.has('brain-injury');
        const hasECMO = selections.context.has('ecmo');
        const hasRhabdo = selections.context.has('rhabdo');
        const hasTLS = selections.context.has('tls');
        const hasCircuitIssues = selections.context.has('circuit-issues');

        // === WEIGHT ===
        const weight = selections.exactWeight || (selections.weight === 'lt60' ? 55 : selections.weight === '60-75' ? 67 : 85);
        const weightCat = weight < 60 ? 'low' : (weight > 75 ? 'high' : 'mid');

        // === MODALITY LOGIC ===
        let modality = 'CVVHDF';
        let modalityReason = 'Default: balanced convective + diffusive clearance';

        // Priority 1: High solute load → CVVHDF (need both mechanisms)
        if (selections.indication.has('toxin') || hasTLS || hasRhabdo) {
            modality = 'CVVHDF';
            modalityReason = 'High solute load \u2192 combination modality for maximum clearance';
        }
        // Priority 2: Isolated volume → SCUF
        else if (selections.indication.has('volume') && selections.indication.size === 1) {
            modality = 'SCUF';
            modalityReason = 'Isolated volume management \u2192 slow continuous ultrafiltration';
            if (isCardiogenic) modalityReason += ' (preferred in cardiogenic shock)';
        }
        // Priority 3: Volume + general clearance (no K+/electrolyte-specific) → CVVH
        else if (selections.indication.has('volume') &&
                 (selections.indication.has('solute-clearance') || selections.indication.has('acidosis-correction') || selections.indication.has('enable-nutrition')) &&
                 !selections.indication.has('electrolyte') &&
                 !selections.indication.has('refractory-k')) {
            modality = 'CVVH';
            modalityReason = 'Volume removal + general clearance goals \u2192 CVVH (convection-based). Effective for medium molecules. No dialysate component.';
            // Caveat: CVVH citrate should avoid K+ >5.5 (no dialysate for K+ clearance)
        }
        // Priority 4: Distributive shock + electrolyte → CVVHD
        else if (isDistributive && selections.indication.has('electrolyte')) {
            modality = 'CVVHD';
            modalityReason = 'Septic shock + electrolyte goals \u2192 diffusive clearance, less haemodynamic impact';
        }
        // Priority 5: Electrolyte-only or K+/Na+ specific → CVVHD
        else if (selections.indication.has('electrolyte') && selections.indication.size === 1) {
            modality = 'CVVHD';
            modalityReason = 'Isolated electrolyte management \u2192 diffusion most efficient for small molecules (K\u207A, Na\u207A, urea)';
        }
        // Default: CVVHDF

        // === ANTICOAGULATION LOGIC ===
        let anticoag = 'Regional Citrate (RCA)';
        let anticoagShort = 'citrate';
        let anticoagReason = 'First-line per KDIGO. Longer circuit life, no systemic anticoagulation.';
        let anticoagMonitoring = '';

        if (liverFail) {
            anticoag = 'Regional Citrate \u2013 CLOSE MONITORING';
            anticoagShort = 'citrate';
            anticoagReason = 'Liver failure: citrate metabolism impaired. Monitor total:ionised Ca\u00B2\u207A ratio Q4h. Consider no anticoagulation if ratio rises.';
            anticoagMonitoring = 'Total:iCa ratio Q4h. If >2.5 or rising \u2192 switch to no anticoag.';
        } else if (isHIT) {
            anticoag = 'Argatroban or Regional Citrate';
            anticoagShort = 'citrate';
            anticoagReason = 'HIT: all heparin products contraindicated. RCA preferred if available, argatroban if not.';
            anticoagMonitoring = 'If argatroban: APTT Q4h (target 1.5\u20133.0\u00D7 baseline). Avoid heparin flushes.';
        } else if (highBleed) {
            anticoag = 'Regional Citrate (preferred) or None';
            anticoagShort = 'citrate';
            anticoagReason = 'High bleeding risk: RCA avoids systemic anticoagulation. Accept shorter filter life if no anticoag used.';
            anticoagMonitoring = 'Monitor circuit pressures hourly. If no anticoag: expect 12\u201324h circuit life.';
        } else if (hasECMO) {
            // ECMO must be checked BEFORE moderate bleeding:
            // Patient is already on systemic heparin for ECMO circuit.
            // Adding citrate would be unnecessary complexity.
            // (HIT and high bleed still override — those are absolute contraindications)
            anticoag = 'Systemic Heparin (shared with ECMO circuit)';
            anticoagShort = 'heparin';
            anticoagReason = 'ECMO already requires systemic heparin. Avoid additional citrate complexity.';
            anticoagMonitoring = 'APTT per ECMO protocol. Monitor anti-Xa if available.';
        } else if (selections.bleeding === 'moderate') {
            anticoag = 'Regional Citrate (RCA)';
            anticoagShort = 'citrate';
            anticoagReason = 'Moderate bleeding risk: citrate preferred (no systemic effect). Monitor coagulation status closely.';
            anticoagMonitoring = 'Check Hb, coags Q8h. Monitor for clinical bleeding. Circuit life assessment Q12h.';
        }

        // Mixed shock additional context
        const isMixed = selections.haemo === 'mixed';

        // =====================================================
        // MICU v6 PROTOCOL LOOKUP TABLES
        // Anticoag-specific & weight-category-specific rates
        // Ported from dosing_adjustment.html
        // =====================================================

        let bloodFlow = 150;
        let dialysate = 0, replacement = 0;
        let preFilterReplacement = 0, postFilterReplacement = 0;
        let protocolNote = '';
        let dialysateFluid = '';
        let replacementFluid = '';
        let replacementPosition = '';
        let filterType = 'M100 (default)';

        // Regiocit flow tracking (for citrate protocols)
        let regiocitFlow = 0; // ml/hr — machine-controlled pre-blood-pump
        const CITRATE_DOSE = 2.5; // mmol/L target in blood
        const REGIOCIT_CONC = 18; // mmol/L citrate in Regiocit solution

        if (modality === 'CVVHDF') {
            if (anticoagShort === 'citrate') {
                // CVVHDF + CITRATE (Regiocit)
                bloodFlow = 150;
                // Regiocit flow = Qb(ml/min) × 60 × citrateDose / regiocitConc
                regiocitFlow = Math.round(bloodFlow * 60 * CITRATE_DOSE / REGIOCIT_CONC);
                postFilterReplacement = 50; // MgSO4 in NS
                replacement = postFilterReplacement;
                dialysate = weightCat === 'low' ? 500 : (weightCat === 'mid' ? 1000 : 1500);
                dialysateFluid = 'Biphozyl';
                replacementFluid = 'MgSO\u2084 in NS';
                replacementPosition = 'post-filter';
                protocolNote = `Citrate (Regiocit) protocol: Regiocit ~${regiocitFlow} ml/hr pre-blood-pump (machine-controlled at citrate dose ${CITRATE_DOSE} mmol/L). Ca compensation 110-120%.`;
            } else if (anticoagShort === 'heparin') {
                // CVVHDF + HEPARIN
                bloodFlow = weightCat === 'high' ? 250 : 200;
                preFilterReplacement = weightCat === 'low' ? 1000 : (weightCat === 'mid' ? 1250 : 1500);
                replacement = preFilterReplacement;
                dialysate = weightCat === 'low' ? 500 : 1000;
                dialysateFluid = 'Prismasol';
                replacementFluid = 'Prismasol';
                replacementPosition = 'pre-filter';
                protocolNote = 'Heparin protocol: Heparin 5 units/kg/hr (target APTT ratio 1.5-2.0 or anti-Xa 0.3-0.5). Pre-filter replacement for additional circuit protection.';
            } else {
                // CVVHDF + NO ANTICOAG
                bloodFlow = weightCat === 'high' ? 250 : 200;
                preFilterReplacement = weightCat === 'low' ? 1250 : (weightCat === 'mid' ? 1500 : 2000);
                replacement = preFilterReplacement;
                dialysate = weightCat === 'low' ? 500 : 1000;
                dialysateFluid = 'Prismasol';
                replacementFluid = 'Prismasol';
                replacementPosition = 'pre-filter';
                protocolNote = 'No anticoag protocol: High pre-filter replacement to reduce filtration fraction and extend circuit life. Higher blood flow (200-250 ml/min) for circuit longevity.';
            }
        } else if (modality === 'CVVH') {
            if (anticoagShort === 'citrate') {
                // CVVH + CITRATE — No dialysate. Replacement post-filter (Biphozyl).
                // Caution: Avoid if K+ >5.5 (no dialysate for K+ clearance)
                bloodFlow = weightCat === 'high' ? 150 : 120;
                regiocitFlow = Math.round(bloodFlow * 60 * CITRATE_DOSE / REGIOCIT_CONC);
                replacement = weightCat === 'low' ? 500 : (weightCat === 'mid' ? 1000 : 1250);
                postFilterReplacement = replacement;
                dialysateFluid = '';
                replacementFluid = 'Biphozyl';
                replacementPosition = 'post-filter';
                protocolNote = `CVVH Citrate: Convection only, no dialysate. Regiocit ~${regiocitFlow} ml/hr pre-BP machine-controlled. \u26A0\uFE0F Avoid if K\u207A >5.5 mmol/L (no dialysate for K\u207A clearance).`;
            } else if (anticoagShort === 'heparin') {
                // CVVH + HEPARIN — Total replacement split 65% pre / 35% post
                bloodFlow = weightCat === 'high' ? 250 : 200;
                const totalRepl = weightCat === 'low' ? 1750 : (weightCat === 'mid' ? 2500 : 3000);
                preFilterReplacement = Math.round(totalRepl * 0.65);
                postFilterReplacement = Math.round(totalRepl * 0.35);
                replacement = totalRepl;
                replacementFluid = 'Prismasol';
                replacementPosition = '65% pre / 35% post';
                protocolNote = 'CVVH Heparin: Convection only. Replacement split 65% pre-filter / 35% post-filter. Heparin 5 units/kg/hr (target APTT <60s).';
            } else {
                // CVVH + NO ANTICOAG — Higher pre-filter fraction (70/30)
                bloodFlow = weightCat === 'high' ? 250 : 200;
                const totalRepl = weightCat === 'low' ? 1750 : (weightCat === 'mid' ? 2500 : 3000);
                preFilterReplacement = Math.round(totalRepl * 0.70);
                postFilterReplacement = Math.round(totalRepl * 0.30);
                replacement = totalRepl;
                replacementFluid = 'Prismasol';
                replacementPosition = '70% pre / 30% post';
                protocolNote = 'CVVH No Anticoag: Higher pre-filter fraction (70%) to maximise circuit protection without anticoagulation.';
            }
        } else if (modality === 'CVVHD') {
            bloodFlow = 150;
            dialysate = weightCat === 'low' ? 500 : (weightCat === 'mid' ? 1000 : 1500);
            dialysateFluid = anticoagShort === 'citrate' ? 'Biphozyl' : 'Prismasol';
            protocolNote = 'CVVHD: Pure diffusion. Most efficient for small molecules (K\u207A, urea). Consider for isolated hyperkalaemia or dysnatraemia.';
        } else if (modality === 'SCUF') {
            bloodFlow = 100;
            protocolNote = 'SCUF: Pure ultrafiltration. No solute clearance. For isolated volume overload only.';
        }

        // Filter selection — M100 (default) or Oxiris (distributive/sepsis)
        // Institution stock: M100 and Oxiris only
        if (isDistributive) {
            filterType = 'Oxiris (adsorptive \u2013 sepsis)';
        } else {
            filterType = 'M100 (default)';
        }

        // === DOSE CALCULATION ===
        // Include Regiocit pre-pump flow in effluent (it contributes to clearance)
        const totalEffluent = dialysate + replacement + regiocitFlow;
        let prescribedDose = weight > 0 ? Math.round(totalEffluent / weight * 10) / 10 : 35;

        // Override for special contexts
        if (hasTLS || hasRhabdo) {
            prescribedDose = Math.max(prescribedDose, 40);
        } else if (isCardiogenic) {
            prescribedDose = Math.min(prescribedDose, 30);
        }

        // Recalculate absolute rates if dose was overridden
        let actualDialysate = dialysate;
        let actualReplacement = replacement;
        let actualPreFilter = preFilterReplacement;
        let actualPostFilter = postFilterReplacement;
        let actualTotalEffluent = totalEffluent; // includes regiocitFlow

        const defaultDose = weight > 0 ? Math.round(totalEffluent / weight * 10) / 10 : 35;
        if (prescribedDose !== defaultDose && totalEffluent > 0) {
            const scaleFactor = (prescribedDose * weight) / totalEffluent;
            actualDialysate = Math.round(dialysate * scaleFactor);
            actualReplacement = Math.round(replacement * scaleFactor);
            actualPreFilter = Math.round(preFilterReplacement * scaleFactor);
            actualPostFilter = Math.round(postFilterReplacement * scaleFactor);
            // Regiocit is machine-controlled and doesn't scale — only dialysate/replacement scale
            actualTotalEffluent = actualDialysate + actualReplacement + regiocitFlow;
        }

        // Context-dependent efficiency factor (must be before deliveredEstimate calculation)
        let efficiencyFactor = 0.72; // Default: 72% (RENAL/ATN evidence)
        let efficiencyNote = 'Standard estimate (RENAL/ATN: 60\u201375%)';
        if (anticoagShort !== 'citrate' && anticoagShort !== 'heparin') {
            efficiencyFactor = 0.60; // No anticoag = more circuit clotting = lower efficiency
            efficiencyNote = 'Lower efficiency expected: no anticoagulation \u2192 shorter circuit life, more downtime';
        } else if (hasCircuitIssues) {
            efficiencyFactor = 0.55;
            efficiencyNote = 'Reduced efficiency: recurrent circuit clotting \u2192 significant downtime expected';
        }

        const deliveredEstimate = Math.round(prescribedDose * efficiencyFactor);
        let doseReason = `Standard ${prescribedDose} ml/kg/hr prescribed \u2192 ~${deliveredEstimate} ml/kg/hr delivered (${efficiencyNote})`;

        if (hasTLS || hasRhabdo) {
            doseReason = 'High solute load \u2192 higher prescribed dose. Monitor delivered dose closely.';
        } else if (isCardiogenic) {
            doseReason = 'Cardiogenic shock \u2192 conservative dosing. Prioritise haemodynamic stability over clearance.';
        }

        // Dialysate:replacement:regiocit ratio
        const dialysatePercent = actualTotalEffluent > 0 ? Math.round(actualDialysate / actualTotalEffluent * 100) : 0;
        const replacementPercent = actualTotalEffluent > 0 ? Math.round(actualReplacement / actualTotalEffluent * 100) : 0;
        const regiocitPercent = actualTotalEffluent > 0 ? Math.round(regiocitFlow / actualTotalEffluent * 100) : 0;

        // === UF RATE ===
        let ufRate = '50\u2013100 ml/hr';
        let ufReason = 'Standard gentle UF';
        let ufCategory = 'moderate';

        if (isCardiogenic) {
            ufRate = '25\u201350 ml/hr (MAX)';
            ufReason = 'Cardiogenic shock: very cautious fluid removal. Reassess MAP/CO continuously.';
            ufCategory = 'conservative';
        } else if (isDistributive) {
            ufRate = '0\u201350 ml/hr initially';
            ufReason = 'Active distributive shock: may not tolerate net UF. Prioritise clearance over fluid removal.';
            ufCategory = 'conservative';
        } else if (isMixed) {
            ufRate = '0\u201375 ml/hr';
            ufReason = 'Mixed/evolving shock: conservative approach. Haemodynamics unpredictable \u2192 reassess Q2\u20134h. Titrate UF based on response.';
            ufCategory = 'conservative';
        } else if (selections.indication.has('pulm-edema')) {
            ufRate = '100\u2013200 ml/hr';
            ufReason = 'Pulmonary oedema: more aggressive UF tolerated if MAP maintained.';
            ufCategory = 'liberal';
        }

        // FIX #6: Override for pulmonary oedema even in shock (if clinically indicated)
        if (selections.indication.has('pulm-edema') && (isDistributive || isMixed)) {
            ufRate = '50\u2013100 ml/hr (cautious)';
            ufReason = 'Pulmonary oedema WITH haemodynamic instability: balance oxygenation vs perfusion. Start low, titrate up if tolerated. Consider vasopressor optimisation first.';
            ufCategory = 'moderate';
        }

        // Delivered dose status
        let deliveredStatus = 'optimal';
        let deliveredStatusText = 'Within target range (20\u201325)';
        if (deliveredEstimate < 20) {
            deliveredStatus = 'low';
            deliveredStatusText = 'Below evidence-based target';
        } else if (deliveredEstimate > 25 && deliveredEstimate <= 30) {
            deliveredStatus = 'suboptimal';
            deliveredStatusText = 'Above standard target \u2013 no proven benefit';
        } else if (deliveredEstimate > 30) {
            deliveredStatus = 'low';
            deliveredStatusText = 'High dose \u2013 IVOIRE showed no benefit';
        }

        // =====================================================
        // RENDER OUTPUT
        // =====================================================

        // Summary strip
        const summaryStrip = document.getElementById('summaryStrip');
        summaryStrip.innerHTML = '';

        const labels = {
            'refractory-k': ['\uD83D\uDEA8 Refractory K\u207A', 'danger'],
            'severe-acidosis': ['\uD83D\uDEA8 Severe Acidosis', 'danger'],
            'pulm-edema': ['\uD83D\uDEA8 Pulm Oedema', 'danger'],
            'uraemic': ['\uD83D\uDEA8 Uraemic', 'danger'],
            'toxin': ['\uD83D\uDEA8 Toxin Removal', 'danger'],
            'volume': ['\uD83D\uDCA7 Volume Mgmt', ''],
            'acidosis-correction': ['\u2697\uFE0F Acidosis Rx', ''],
            'electrolyte': ['\uD83E\uDDEA Electrolyte', ''],
            'solute-clearance': ['\uD83D\uDD2C Solute Clearance', ''],
            'enable-nutrition': ['\uD83E\uDD64 Enable Nutrition', ''],
            'temp-mgmt': ['\uD83C\uDF21\uFE0F Temperature', ''],
            'brain-injury': ['\uD83E\uDDE0 Brain Injury', 'warning'],
            'ecmo': ['\uD83D\uDD04 ECMO', 'warning'],
            'post-cardiac': ['\uD83E\uDEC0 Post-Cardiac', ''],
            'rhabdo': ['\uD83D\uDCAA Rhabdomyolysis', 'warning'],
            'tls': ['\uD83E\uDDEC TLS', 'warning'],
            'dysnatemia': ['\uD83E\uDDEA Dysnatraemia', 'warning'],
            'pregnancy': ['\uD83E\uDD30 Pregnancy', ''],
            'circuit-issues': ['\uD83D\uDD04 Circuit Issues', 'warning']
        };

        selections.indication.forEach(v => {
            const [text, cls] = labels[v] || [v, ''];
            summaryStrip.innerHTML += `<span class="summary-tag ${cls}">${text}</span>`;
        });
        selections.context.forEach(v => {
            const [text, cls] = labels[v] || [v, ''];
            summaryStrip.innerHTML += `<span class="summary-tag ${cls}">${text}</span>`;
        });

        // Title
        const weightBandLabel = weightCat === 'low' ? '<60 kg band' : (weightCat === 'high' ? '>75 kg band' : '60\u201375 kg band');
        document.getElementById('rxTitle').textContent = `${modality} \u2013 ${anticoag}`;
        document.getElementById('rxSubtitle').textContent = `Generated from ${selections.indication.size} indication(s) \u2022 ${weight} kg (${weightBandLabel}) \u2022 ${hasEmergency ? 'URGENT' : 'Standard'} priority`;

        // >100kg warning
        if (weight > 100) {
            document.getElementById('summaryStrip').innerHTML += `<span class="summary-tag warning">\u26A0\uFE0F >100 kg \u2013 protocol designed for \u2264100 kg, customised Rx may be needed</span>`;
        }

        // === SETTINGS GRID (matching dosing_adjustment.html) ===
        const grid = document.getElementById('settingsGrid');
        let gridHTML = `
            <div class="setting-item">
                <div class="setting-label">Mode</div>
                <div class="setting-value" style="font-size: 14px;">${modality}</div>
                <div class="setting-why">Based on goals</div>
            </div>
            <div class="setting-item">
                <div class="setting-label">Blood Flow</div>
                <div class="setting-value">${bloodFlow} <span class="setting-unit">ml/min</span></div>
                <div class="setting-why">${anticoagShort === 'citrate' ? 'Fixed (citrate)' : 'Higher Qb \u2192 circuit life'}</div>
            </div>`;

        if (actualDialysate > 0) {
            gridHTML += `
            <div class="setting-item">
                <div class="setting-label">Dialysate${dialysateFluid ? ' (' + dialysateFluid + ')' : ''}</div>
                <div class="setting-value">${actualDialysate} <span class="setting-unit">ml/hr</span></div>
                <div class="setting-why">Diffusion${dialysatePercent ? ' \u2022 ' + dialysatePercent + '% of effluent' : ''}</div>
            </div>`;
        }

        if (regiocitFlow > 0) {
            gridHTML += `
            <div class="setting-item">
                <div class="setting-label">Regiocit (pre-pump)</div>
                <div class="setting-value">~${regiocitFlow} <span class="setting-unit">ml/hr</span></div>
                <div class="setting-why">Machine-controlled \u2022 citrate ${CITRATE_DOSE} mmol/L</div>
            </div>`;
        }

        if (actualReplacement > 0) {
            gridHTML += `
            <div class="setting-item">
                <div class="setting-label">Replacement${replacementFluid ? ' (' + replacementFluid + ')' : ''}</div>
                <div class="setting-value">${actualReplacement} <span class="setting-unit">ml/hr</span></div>
                <div class="setting-why">${replacementPosition || 'Convection'}${replacementPercent ? ' \u2022 ' + replacementPercent + '% of effluent' : ''}</div>
            </div>`;
        }

        if (actualPreFilter > 0 && actualPostFilter > 0) {
            gridHTML += `
            <div class="setting-item span-2">
                <div class="setting-label">Replacement Split</div>
                <div class="setting-value" style="font-size: 12px;">Pre: ${actualPreFilter} ml/hr | Post: ${actualPostFilter} ml/hr</div>
                <div class="setting-why">${replacementPosition}</div>
            </div>`;
        }

        gridHTML += `
            <div class="setting-item">
                <div class="setting-label">Net UF Rate</div>
                <div class="setting-value" style="font-size: 13px;">${ufRate}</div>
                <div class="setting-why">${ufCategory}</div>
            </div>
            <div class="setting-item">
                <div class="setting-label">Prescribed Dose</div>
                <div class="setting-value">${prescribedDose} <span class="setting-unit">ml/kg/hr</span></div>
            </div>
            <div class="setting-item">
                <div class="setting-label">Expected Delivered</div>
                <div class="setting-value">~${deliveredEstimate} <span class="setting-unit">ml/kg/hr</span></div>
                <div class="setting-why">${Math.round(efficiencyFactor * 100)}% efficiency</div>
            </div>
            <div class="setting-item">
                <div class="setting-label">Filter</div>
                <div class="setting-value" style="font-size: 11px;">${filterType}</div>
            </div>`;

        grid.innerHTML = gridHTML;

        // Protocol note
        document.getElementById('protocolNote').innerHTML = protocolNote ?
            `<div class="protocol-note"><strong>\uD83D\uDCCB Protocol basis:</strong> ${protocolNote}</div>` : '';

        // === CITRATE SECTION ===
        const citrateSec = document.getElementById('citrateSection');
        if (anticoagShort === 'citrate') {
            const caInfusion = '10\u201320'; // Starting range, titrate to systemic iCa
            citrateSec.innerHTML = `
                <div class="citrate-section">
                    <h3>\uD83D\uDED1 Citrate Protocol (Regiocit)</h3>
                    <div class="detail">
                        <strong>Starting rates:</strong><br>
                        \u2022 Regiocit: ~${regiocitFlow} ml/hr pre-blood-pump (machine-controlled at citrate dose ${CITRATE_DOSE} mmol/L)<br>
                        \u2022 Calcium gluconate 10% infusion: ${caInfusion} ml/hr (titrate to systemic iCa)<br>
                        \u2022 NaHCO\u2083 8.45%: 0 / 25 / 50 ml/hr (target pH 7.25\u20137.45)<br><br>
                        <strong>Monitoring targets:</strong><br>
                        \u2022 Post-filter iCa: 0.25\u20130.35 mmol/L (circuit anticoagulation)<br>
                        \u2022 Systemic iCa: 1.0\u20131.2 mmol/L<br>
                        \u2022 Total Ca:iCa ratio: &lt;2.5 (citrate accumulation marker)<br>
                        \u2022 Check iCa 1h post-start, then Q6h when stable
                        ${liverFail ? '<br><br><strong>\u26A0\uFE0F Liver Failure:</strong> Impaired citrate metabolism \u2192 check total:ionised Ca\u00B2\u207A ratio Q4h. If ratio >2.5 or rising trend, consider switching to no anticoagulation.' : ''}
                    </div>
                </div>`;
        } else {
            citrateSec.innerHTML = '';
        }

        // === DOSE TRANSPARENCY SECTION ===
        let doseBreakdownHTML = '';
        if (regiocitFlow > 0) {
            doseBreakdownHTML = `
                    <div style="font-size: 12px; font-weight: 600; color: var(--text); margin-bottom: 6px;">Effluent Breakdown (Citrate Protocol)</div>
                    <div class="formula">
                        Total Effluent = Regiocit + Dialysate + Replacement<br>
                        <strong>${actualTotalEffluent} ml/hr</strong> = ${regiocitFlow} (Regiocit) + ${actualDialysate} (Biphozyl) + ${actualReplacement} (MgSO\u2084)<br><br>
                        Prescribed Dose = Total Effluent \u00F7 Weight<br>
                        <strong>${prescribedDose} ml/kg/hr</strong> = ${actualTotalEffluent} \u00F7 ${weight} kg
                    </div>
                    <div class="explanation">
                        <strong>Why Regiocit is included:</strong> Regiocit (~${regiocitFlow} ml/hr) runs pre-blood-pump and contributes to solute clearance.
                        It accounts for ~${regiocitPercent}% of total effluent. The MICU v6 protocol dose ranges (>30 ml/kg/hr) include this flow.
                    </div>`;
        } else {
            doseBreakdownHTML = `
                    <div style="font-size: 12px; font-weight: 600; color: var(--text); margin-bottom: 6px;">Effluent Breakdown</div>
                    <div class="formula">
                        Total Effluent = Dialysate + Replacement<br>
                        <strong>${actualTotalEffluent} ml/hr</strong> = ${actualDialysate} + ${actualReplacement}<br><br>
                        Prescribed Dose = Total Effluent \u00F7 Weight<br>
                        <strong>${prescribedDose} ml/kg/hr</strong> = ${actualTotalEffluent} \u00F7 ${weight} kg
                    </div>`;
        }

        document.getElementById('doseSection').innerHTML = `
            <div class="dose-section">
                <h3>\uD83D\uDC8A Dose Personalisation</h3>
                <div class="dose-transparency-box">
                    ${doseBreakdownHTML}
                </div>

                <div class="dose-transparency-box" style="margin-top: 10px;">
                    <div style="font-size: 12px; font-weight: 600; color: var(--text); margin-bottom: 6px;">\uD83D\uDD0D Prescribed vs Delivered</div>
                    <div class="formula">
                        Target Delivered = Prescribed \u00D7 Efficiency Factor<br>
                        <strong>${deliveredEstimate} ml/kg/hr</strong> = ${prescribedDose} \u00D7 ${Math.round(efficiencyFactor * 100)}%
                    </div>
                    <div class="explanation">
                        <strong>Evidence basis:</strong> RENAL/ATN trials prescribed 35\u201340 ml/kg/hr but achieved
                        only 20\u201325 ml/kg/hr delivered (${Math.round(efficiencyFactor * 100)}% efficiency due to circuit downtime, clotting, procedures).
                    </div>
                </div>

                <div class="dose-live-calc">
                    <div class="dose-live-box">
                        <div class="dose-live-label">Prescribed</div>
                        <div class="dose-live-value prescribed">${prescribedDose}<span class="dose-unit"> ml/kg/hr</span></div>
                        <div style="font-size: 9px; color: var(--text-light);">What you order</div>
                    </div>
                    <div class="dose-arrow">\u2192</div>
                    <div class="dose-live-box">
                        <div class="dose-live-label">Expected Delivered</div>
                        <div class="dose-live-value delivered ${deliveredStatus === 'suboptimal' ? 'warning-val' : deliveredStatus === 'low' ? 'danger-val' : ''}">${deliveredEstimate}<span class="dose-unit"> ml/kg/hr</span></div>
                        <div class="dose-status-badge ${deliveredStatus}">${deliveredStatusText}</div>
                    </div>
                </div>
            </div>`;

        // === UF SECTION ===
        document.getElementById('ufSection').innerHTML = `
            <div class="uf-section ${ufCategory}">
                <h3>\uD83D\uDCA7 UF Rate: ${ufCategory.toUpperCase()}</h3>
                <div class="detail">
                    <strong>Recommended: ${ufRate}</strong><br><br>
                    <strong>Clinical Rationale:</strong> ${ufReason}
                </div>
            </div>`;

        // === MONITORING SECTION ===
        let monitorItems = [];
        
        // Core labs — always
        monitorItems.push({
            title: '\uD83E\uDDEA Core Labs',
            items: [
                'ABG + iCa: 1h post-start, then Q6h when stable',
                'UEC (Na\u207A, K\u207A, Cl\u207B, HCO\u2083\u207B, urea, creatinine): Q6\u20138h',
                'Mg\u00B2\u207A, PO\u2084\u00B3\u207B: Q12h (replete aggressively)',
                'FBC: Daily (watch platelets for HIT screening)'
            ]
        });

        // Anticoag-specific monitoring
        if (anticoagShort === 'citrate') {
            monitorItems.push({
                title: '\uD83D\uDED1 Citrate Monitoring',
                items: [
                    'Post-filter iCa: target 0.25\u20130.35 mmol/L (Q1h \u00D72, then Q6h)',
                    'Systemic iCa: target 1.0\u20131.2 mmol/L',
                    'Total Ca:ionised Ca ratio: <2.5 (citrate accumulation marker)',
                    liverFail ? '\u26A0\uFE0F Liver failure: check total:iCa ratio Q4h' : 'Lactate (rising may indicate citrate accumulation)'
                ].filter(Boolean)
            });
        } else if (anticoagShort === 'heparin') {
            monitorItems.push({
                title: '\uD83D\uDEE1\uFE0F Heparin Monitoring',
                items: [
                    'APTT: Q6h (target <60s or ratio 1.5\u20132.0)',
                    'Anti-Xa: 0.3\u20130.5 IU/ml (if available, more reliable in ICU)',
                    'Platelet count: Daily (4T score if drop >30%)',
                    'Watch for: bleeding at catheter site, mucosal bleeding'
                ]
            });
        } else {
            monitorItems.push({
                title: '\uD83D\uDEE1\uFE0F No Anticoagulation',
                items: [
                    'Circuit pressures: Q1\u20132h (watch for rising TMP/access pressure)',
                    'Expected circuit life: 12\u201324h (saline flushes Q4h may help)',
                    'Signs of clotting: darkening in filter, rising TMP, drop in filtration',
                    'Prepare replacement circuit proactively'
                ]
            });
        }

        // Circuit monitoring
        monitorItems.push({
            title: '\uD83D\uDD04 Circuit Assessment',
            items: [
                'Access/return pressures: Trend Q4h',
                'TMP (transmembrane pressure): Rising = filter clotting',
                'Effluent colour: Should be clear/pale yellow',
                'Filter inspection: Visual check for darkening/clots'
            ]
        });

        // Haemodynamic monitoring based on shock state
        if (isDistributive || isCardiogenic || isMixed) {
            monitorItems.push({
                title: '\uD83E\uDEC0 Haemodynamic Monitoring',
                items: [
                    'MAP: Continuous. Target \u226565 mmHg (or individualised)',
                    `Vasopressor trend: ${isDistributive ? 'Expect possible increase during first 2h of CRRT' : 'Monitor closely for decompensation'}`,
                    'Fluid balance: Strict I/O charting Q1h',
                    isMixed ? 'Reassess shock phenotype Q2\u20134h \u2014 haemodynamics may evolve' : 'Cardiac output assessment if available (POCUS/PAC)'
                ]
            });
        }

        // Context-specific monitoring
        if (hasBrainInjury) {
            monitorItems.push({
                title: '\uD83E\uDDE0 Neuro Monitoring',
                items: [
                    'Serum Na\u207A: Q4h (target correction <8 mmol/24h)',
                    'Serum osmolality: Q6h',
                    'GCS/pupil assessment: Q2h during correction'
                ]
            });
        }
        if (hasTLS) {
            monitorItems.push({
                title: '\uD83E\uDDEC TLS Monitoring',
                items: [
                    'Uric acid, PO\u2084, K\u207A, Ca\u00B2\u207A: Q4\u20136h',
                    'LDH: Daily (tumour burden marker)',
                    'ECG: Watch for QTc changes from electrolyte shifts'
                ]
            });
        }
        if (hasRhabdo) {
            monitorItems.push({
                title: '\uD83D\uDCAA Rhabdo Monitoring',
                items: [
                    'CK: Q8\u201312h (trending down = response)',
                    'K\u207A: Q4\u20136h (release from damaged muscle)',
                    'Myoglobin clearance: Watch urine colour',
                    'Compartment pressures if clinical concern'
                ]
            });
        }

        let monitorHTML = monitorItems.map(section => `
            <div style="margin-bottom: 12px;">
                <div style="font-size: 13px; font-weight: 700; color: var(--primary); margin-bottom: 6px;">${section.title}</div>
                <div style="font-size: 12px; color: var(--text-mid); line-height: 1.6;">
                    ${section.items.map(item => '\u2022 ' + item).join('<br>')}
                </div>
            </div>
        `).join('');

        document.getElementById('monitoringSection').innerHTML = `
            <div class="rx-card" style="margin-bottom: 20px;">
                <div style="padding: 20px; border-top: 4px solid var(--primary);">
                    <h3 style="font-size: 15px; font-weight: 700; color: var(--primary); margin-bottom: 16px;">\uD83D\uDCCB Monitoring Plan</h3>
                    ${anticoagMonitoring ? `<div style="padding: 10px 14px; background: var(--warning-wash); border-left: 3px solid var(--warning); border-radius: 4px; margin-bottom: 14px; font-size: 12px; color: #92400e;"><strong>\u26A0\uFE0F Anticoag Alert:</strong> ${anticoagMonitoring}</div>` : ''}
                    ${monitorHTML}
                </div>
            </div>`;

        // === SEPSIS EVIDENCE (conditional) ===
        const sepsisSec = document.getElementById('sepsisSection');
        if (isDistributive) {
            sepsisSec.innerHTML = `
                <div class="sepsis-section">
                    <h3>\uD83E\uDDA0 Sepsis &amp; High-Dose CRRT Evidence</h3>
                    <div class="detail">
                        <strong>Current evidence does NOT support high-volume hemofiltration:</strong><br><br>
                        <strong>IVOIRE Trial (2013, n=137):</strong> HVHF 70 ml/kg/hr vs standard 35 ml/kg/hr showed NO mortality benefit, NO improvement in haemodynamics at 28 days.<br><br>
                        <strong>Cochrane Review (2017):</strong> No beneficial effect of HVHF during sepsis.<br><br>
                        <strong>Key insight:</strong> Cytokine removal is primarily by ADSORPTION (membrane binding) not convection. Higher flow doesn't improve cytokine clearance. Consider adsorptive membranes (Oxiris, PMMA) rather than dose escalation.
                    </div>
                </div>`;
        } else {
            sepsisSec.innerHTML = '';
        }

        // === PROTOCOL TABLE ===
        const ptSection = document.getElementById('protocolTableSection');
        const activeCol = weightCat === 'low' ? 1 : (weightCat === 'mid' ? 2 : 3);
        let tableHTML = '';

        if (modality === 'CVVHDF' && anticoagShort === 'citrate') {
            tableHTML = `
                <div class="protocol-table-section">
                    <h3>\uD83D\uDCCB MICU Protocol Reference Table</h3>
                    <div class="table-note">Based on MICU RRT Protocol Version 6.0 \u2022 Citrate anticoagulation</div>
                    <table class="protocol-table">
                        <thead>
                            <tr><th class="header-row" colspan="4">CVVHDF (Regiocit) \u2013 Citrate Anticoagulation</th></tr>
                            <tr>
                                <th>Parameter</th>
                                <th ${activeCol===1?'class="active-weight"':''}>&#60;60 kg</th>
                                <th ${activeCol===2?'class="active-weight"':''}>60\u201375 kg</th>
                                <th ${activeCol===3?'class="active-weight"':''}>&#62;75 kg</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Blood Flow</td><td ${activeCol===1?'class="active-weight"':''}>150 ml/min</td><td ${activeCol===2?'class="active-weight"':''}>150 ml/min</td><td ${activeCol===3?'class="active-weight"':''}>150 ml/min</td></tr>
                            <tr><td>Regiocit (pre-pump)</td><td colspan="3">~${regiocitFlow} ml/hr (machine-controlled, citrate ${CITRATE_DOSE} mmol/L)</td></tr>
                            <tr><td>MgSO\u2084 in NS (post-filter)</td><td ${activeCol===1?'class="active-weight"':''}>50 ml/hr</td><td ${activeCol===2?'class="active-weight"':''}>50 ml/hr</td><td ${activeCol===3?'class="active-weight"':''}>50 ml/hr</td></tr>
                            <tr><td>Biphozyl (Dialysate)</td><td ${activeCol===1?'class="active-weight"':''}>500 ml/hr</td><td ${activeCol===2?'class="active-weight"':''}>1000 ml/hr</td><td ${activeCol===3?'class="active-weight"':''}>1500 ml/hr</td></tr>
                            <tr><td>NaHCO\u2083 8.45%</td><td colspan="3">0 / 25 / 50 ml/hr (target pH 7.25\u20137.45)</td></tr>
                            <tr><td>Prescribed Dose</td><td ${activeCol===1?'class="active-weight"':''}>&#62;30 ml/kg/hr</td><td ${activeCol===2?'class="active-weight"':''}>31\u201338 ml/kg/hr</td><td ${activeCol===3?'class="active-weight"':''}>&#60;37 ml/kg/hr</td></tr>
                        </tbody>
                    </table>
                </div>`;
        } else if (modality === 'CVVHDF' && anticoagShort === 'heparin') {
            tableHTML = `
                <div class="protocol-table-section">
                    <h3>\uD83D\uDCCB MICU Protocol Reference Table</h3>
                    <div class="table-note">Based on MICU RRT Protocol Version 6.0 \u2022 Heparin anticoagulation</div>
                    <table class="protocol-table">
                        <thead>
                            <tr><th class="header-row" colspan="4">CVVHDF (Prismasol) \u2013 Heparin</th></tr>
                            <tr>
                                <th>Parameter</th>
                                <th ${activeCol===1?'class="active-weight"':''}>&#60;60 kg</th>
                                <th ${activeCol===2?'class="active-weight"':''}>60\u201375 kg</th>
                                <th ${activeCol===3?'class="active-weight"':''}>&#62;75 kg</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Blood Flow</td><td ${activeCol===1?'class="active-weight"':''}>200 ml/min</td><td ${activeCol===2?'class="active-weight"':''}>200 ml/min</td><td ${activeCol===3?'class="active-weight"':''}>250 ml/min</td></tr>
                            <tr><td>Replacement (pre-filter)</td><td ${activeCol===1?'class="active-weight"':''}>1000 ml/hr</td><td ${activeCol===2?'class="active-weight"':''}>1250 ml/hr</td><td ${activeCol===3?'class="active-weight"':''}>1500 ml/hr</td></tr>
                            <tr><td>Dialysate</td><td ${activeCol===1?'class="active-weight"':''}>500 ml/hr</td><td ${activeCol===2?'class="active-weight"':''}>1000 ml/hr</td><td ${activeCol===3?'class="active-weight"':''}>1000 ml/hr</td></tr>
                            <tr><td>Heparin Start</td><td colspan="3">5 units/kg/hr (target APTT &#60;60s)</td></tr>
                        </tbody>
                    </table>
                </div>`;
        } else if (modality === 'CVVHDF') {
            // No anticoag default table
            tableHTML = `
                <div class="protocol-table-section">
                    <h3>\uD83D\uDCCB MICU Protocol Reference Table</h3>
                    <div class="table-note">Based on MICU RRT Protocol Version 6.0 \u2022 No anticoagulation</div>
                    <table class="protocol-table">
                        <thead>
                            <tr><th class="header-row" colspan="4">CVVHDF (Prismasol) \u2013 No Anticoagulation</th></tr>
                            <tr>
                                <th>Parameter</th>
                                <th ${activeCol===1?'class="active-weight"':''}>&#60;60 kg</th>
                                <th ${activeCol===2?'class="active-weight"':''}>60\u201375 kg</th>
                                <th ${activeCol===3?'class="active-weight"':''}>&#62;75 kg</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Blood Flow</td><td ${activeCol===1?'class="active-weight"':''}>200 ml/min</td><td ${activeCol===2?'class="active-weight"':''}>200 ml/min</td><td ${activeCol===3?'class="active-weight"':''}>250 ml/min</td></tr>
                            <tr><td>Replacement (pre-filter)</td><td ${activeCol===1?'class="active-weight"':''}>1250 ml/hr</td><td ${activeCol===2?'class="active-weight"':''}>1500 ml/hr</td><td ${activeCol===3?'class="active-weight"':''}>2000 ml/hr</td></tr>
                            <tr><td>Dialysate</td><td ${activeCol===1?'class="active-weight"':''}>500 ml/hr</td><td ${activeCol===2?'class="active-weight"':''}>1000 ml/hr</td><td ${activeCol===3?'class="active-weight"':''}>1000 ml/hr</td></tr>
                        </tbody>
                    </table>
                </div>`;
        } else if (modality === 'CVVH' && anticoagShort === 'citrate') {
            tableHTML = `
                <div class="protocol-table-section">
                    <h3>\uD83D\uDCCB MICU Protocol Reference Table</h3>
                    <div class="table-note">Based on MICU RRT Protocol Version 6.0 \u2022 CVVH Citrate</div>
                    <table class="protocol-table">
                        <thead>
                            <tr><th class="header-row" colspan="4">CVVH (Regiocit) \u2013 Citrate Anticoagulation</th></tr>
                            <tr>
                                <th>Parameter</th>
                                <th ${activeCol===1?'class="active-weight"':''}>&#60;60 kg</th>
                                <th ${activeCol===2?'class="active-weight"':''}>60\u201375 kg</th>
                                <th ${activeCol===3?'class="active-weight"':''}>&#62;75 kg</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Blood Flow</td><td ${activeCol===1?'class="active-weight"':''}>120 ml/min</td><td ${activeCol===2?'class="active-weight"':''}>120 ml/min</td><td ${activeCol===3?'class="active-weight"':''}>150 ml/min</td></tr>
                            <tr><td>Regiocit (pre-pump)</td><td colspan="3">~${regiocitFlow} ml/hr (machine-controlled, citrate ${CITRATE_DOSE} mmol/L)</td></tr>
                            <tr><td>Replacement (Biphozyl, post-filter)</td><td ${activeCol===1?'class="active-weight"':''}>500 ml/hr</td><td ${activeCol===2?'class="active-weight"':''}>1000 ml/hr</td><td ${activeCol===3?'class="active-weight"':''}>1250 ml/hr</td></tr>
                            <tr><td>Dialysate</td><td colspan="3">None (convection only)</td></tr>
                        </tbody>
                    </table>
                    <div class="table-note" style="color: #dc2626; margin-top: 8px;">\u26A0\uFE0F Avoid CVVH + Citrate if K\u207A >5.5 mmol/L (no dialysate for K\u207A clearance)</div>
                </div>`;
        } else if (modality === 'CVVH' && anticoagShort === 'heparin') {
            tableHTML = `
                <div class="protocol-table-section">
                    <h3>\uD83D\uDCCB MICU Protocol Reference Table</h3>
                    <div class="table-note">Based on MICU RRT Protocol Version 6.0 \u2022 CVVH Heparin</div>
                    <table class="protocol-table">
                        <thead>
                            <tr><th class="header-row" colspan="4">CVVH (Prismasol) \u2013 Heparin</th></tr>
                            <tr>
                                <th>Parameter</th>
                                <th ${activeCol===1?'class="active-weight"':''}>&#60;60 kg</th>
                                <th ${activeCol===2?'class="active-weight"':''}>60\u201375 kg</th>
                                <th ${activeCol===3?'class="active-weight"':''}>&#62;75 kg</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Blood Flow</td><td ${activeCol===1?'class="active-weight"':''}>200 ml/min</td><td ${activeCol===2?'class="active-weight"':''}>200 ml/min</td><td ${activeCol===3?'class="active-weight"':''}>250 ml/min</td></tr>
                            <tr><td>Total Replacement</td><td ${activeCol===1?'class="active-weight"':''}>1750 ml/hr</td><td ${activeCol===2?'class="active-weight"':''}>2500 ml/hr</td><td ${activeCol===3?'class="active-weight"':''}>3000 ml/hr</td></tr>
                            <tr><td>Split</td><td colspan="3">65% pre-filter / 35% post-filter</td></tr>
                            <tr><td>Dialysate</td><td colspan="3">None (convection only)</td></tr>
                            <tr><td>Heparin</td><td colspan="3">5 units/kg/hr (target APTT &#60;60s)</td></tr>
                        </tbody>
                    </table>
                </div>`;
        } else if (modality === 'CVVH') {
            tableHTML = `
                <div class="protocol-table-section">
                    <h3>\uD83D\uDCCB MICU Protocol Reference Table</h3>
                    <div class="table-note">Based on MICU RRT Protocol Version 6.0 \u2022 CVVH No anticoagulation</div>
                    <table class="protocol-table">
                        <thead>
                            <tr><th class="header-row" colspan="4">CVVH (Prismasol) \u2013 No Anticoagulation</th></tr>
                            <tr>
                                <th>Parameter</th>
                                <th ${activeCol===1?'class="active-weight"':''}>&#60;60 kg</th>
                                <th ${activeCol===2?'class="active-weight"':''}>60\u201375 kg</th>
                                <th ${activeCol===3?'class="active-weight"':''}>&#62;75 kg</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Blood Flow</td><td ${activeCol===1?'class="active-weight"':''}>200 ml/min</td><td ${activeCol===2?'class="active-weight"':''}>200 ml/min</td><td ${activeCol===3?'class="active-weight"':''}>250 ml/min</td></tr>
                            <tr><td>Total Replacement</td><td ${activeCol===1?'class="active-weight"':''}>1750 ml/hr</td><td ${activeCol===2?'class="active-weight"':''}>2500 ml/hr</td><td ${activeCol===3?'class="active-weight"':''}>3000 ml/hr</td></tr>
                            <tr><td>Split</td><td colspan="3">70% pre-filter / 30% post-filter</td></tr>
                            <tr><td>Dialysate</td><td colspan="3">None (convection only)</td></tr>
                        </tbody>
                    </table>
                </div>`;
        }

        ptSection.innerHTML = tableHTML;

        // === CLINICAL PROMPTS ===
        let prompts = [];
        if (prescribedDose < 30) {
            prompts.push('Lower prescribed dose may result in delivered dose below target 20 ml/kg/hr');
            prompts.push('Consider: Is this for pure SCUF/volume removal only?');
        }
        if (prescribedDose > 40) {
            prompts.push('High-dose CRRT (>35\u201340 ml/kg/hr) shows NO mortality benefit');
            prompts.push('IVOIRE trial: 70 vs 35 ml/kg/hr \u2013 no difference in sepsis outcomes');
            prompts.push('Consider: Is the goal better achieved by modality change or filter selection?');
        }
        if (deliveredEstimate < 20) {
            prompts.push('Expected delivered dose <20 ml/kg/hr may be subtherapeutic');
            prompts.push('ATN/RENAL trials targeted delivered dose of 20\u201325 ml/kg/hr');
        }
        if (hasEmergency) {
            prompts.push('Emergency indication present \u2013 do not delay initiation for optimisation. Start now, refine later.');
        }
        if (modality === 'CVVH' && anticoagShort === 'citrate') {
            prompts.push('\u26A0\uFE0F CVVH + Citrate: No dialysate component \u2192 limited K\u207A clearance. If K\u207A >5.5 mmol/L, switch to CVVHDF for diffusive K\u207A removal.');
        }
        if (modality === 'CVVH') {
            prompts.push('CVVH = convection only. Good for medium molecules and volume. If small molecule clearance becomes a priority (K\u207A, urea), consider switching to CVVHDF.');
        }

        document.getElementById('clinicalPrompts').innerHTML = prompts.length > 0 ?
            `<div class="clinical-prompts">
                <h4>\uD83E\uDD14 Critical Thinking Prompts</h4>
                <ul>${prompts.map(p => `<li>${p}</li>`).join('')}</ul>
            </div>` : '';

        // === KEY EVIDENCE BOX ===
        document.getElementById('evidenceBox').innerHTML = `
            <div class="evidence-box">
                <strong>\uD83D\uDCDA Key Evidence:</strong>
                \u2022 <strong>RENAL (2009):</strong> 40 vs 25 ml/kg/hr \u2013 no mortality difference<br>
                \u2022 <strong>ATN (2008):</strong> 35 vs 20 ml/kg/hr \u2013 no mortality difference<br>
                \u2022 <strong>IVOIRE (2013):</strong> 70 vs 35 ml/kg/hr in sepsis \u2013 no benefit from high-volume<br>
                \u2022 <strong>Target:</strong> Delivered dose 20\u201325 ml/kg/hr is standard of care
            </div>`;

        // === CLINICAL REASONING ===
        const reasoningBody = document.getElementById('reasoningBody');
        let reasoning = '';
        reasoning += `<div class="reasoning-item"><span class="r-icon">\uD83C\uDFAF</span><span><strong>Modality:</strong> ${modalityReason}</span></div>`;
        reasoning += `<div class="reasoning-item"><span class="r-icon">\uD83D\uDEE1\uFE0F</span><span><strong>Anticoagulation:</strong> ${anticoagReason}</span></div>`;
        reasoning += `<div class="reasoning-item"><span class="r-icon">\uD83D\uDC8A</span><span><strong>Dose:</strong> ${doseReason}</span></div>`;
        reasoning += `<div class="reasoning-item"><span class="r-icon">\uD83D\uDCA7</span><span><strong>UF Rate:</strong> ${ufReason}</span></div>`;

        if (hasEmergency) {
            reasoning += `<div class="reasoning-item"><span class="r-icon">\uD83D\uDEA8</span><span><strong>Urgency:</strong> Emergency indication present. Do not delay initiation for optimisation. Start now, refine later.</span></div>`;
        }

        reasoningBody.innerHTML = reasoning;

        // === EVIDENCE BODY ===
        const evidenceBody = document.getElementById('evidenceBody');
        let evidence = '';
        evidence += `<div class="reasoning-item"><span class="r-icon">\uD83D\uDCD6</span><span><strong>RENAL Trial (2009):</strong> 25 vs 40 ml/kg/hr \u2013 no difference in 90-day mortality. Target delivered dose 20\u201325. <span class="evidence-pill">N=1508</span></span></div>`;
        evidence += `<div class="reasoning-item"><span class="r-icon">\uD83D\uDCD6</span><span><strong>ATN Trial (2008):</strong> Intensive vs standard dosing \u2013 no benefit from higher dose. <span class="evidence-pill">N=1124</span></span></div>`;

        if (hasTLS || hasRhabdo || isDistributive) {
            evidence += `<div class="reasoning-item"><span class="r-icon">\uD83D\uDCD6</span><span><strong>IVOIRE Trial:</strong> 70 vs 35 ml/kg/hr in septic AKI \u2013 no mortality benefit from high-volume HF. <span class="evidence-pill">N=140</span></span></div>`;
        }

        if (hasEmergency) {
            evidence += `<div class="reasoning-item"><span class="r-icon">\uD83D\uDCD6</span><span><strong>STARRT-AKI (2020):</strong> Accelerated vs standard timing \u2013 no benefit from early start. But emergency indications (Tier 1) override timing studies. <span class="evidence-pill">N=2927</span></span></div>`;
        }

        evidence += `<div class="reasoning-item"><span class="r-icon">\uD83D\uDCD6</span><span><strong>KDIGO 2012:</strong> Regional citrate anticoagulation recommended as first-line for CRRT in patients without contraindications.</span></div>`;

        evidenceBody.innerHTML = evidence;

        // === CONTEXT WARNINGS ===
        let warnings = '';
        if (isMixed) {
            warnings += `
            <div class="rx-card" style="margin-bottom: 12px;">
                <div style="padding: 16px 20px; border-left: 4px solid var(--warning); background: var(--warning-wash);">
                    <div style="font-size: 13px; font-weight: 700; color: #92400e; margin-bottom: 6px;">\uD83D\uDD04 Mixed/Evolving Shock</div>
                    <div style="font-size: 12px; color: var(--text-mid);">Haemodynamics are unpredictable. Reassess shock phenotype Q2\u20134h. UF settings are conservative \u2014 titrate based on response. Be prepared to pause UF or adjust modality as picture evolves.</div>
                </div>
            </div>`;
        }
        if (hasBrainInjury) {
            warnings += `
            <div class="rx-card" style="margin-bottom: 12px;">
                <div style="padding: 16px 20px; border-left: 4px solid var(--warning); background: var(--warning-wash);">
                    <div style="font-size: 13px; font-weight: 700; color: #92400e; margin-bottom: 6px;">\u26A0\uFE0F Brain Injury Modification</div>
                    <div style="font-size: 12px; color: var(--text-mid);">Custom dialysate Na\u207A to match serum \u00B15 mmol/L. Avoid rapid osmolality shifts. Monitor Na\u207A Q4h. Target correction rate &lt;8 mmol/24h.</div>
                </div>
            </div>`;
        }
        if (hasCircuitIssues) {
            warnings += `
            <div class="rx-card" style="margin-bottom: 12px;">
                <div style="padding: 16px 20px; border-left: 4px solid var(--warning); background: var(--warning-wash);">
                    <div style="font-size: 13px; font-weight: 700; color: #92400e; margin-bottom: 6px;">\uD83D\uDD04 Circuit Clotting Strategy</div>
                    <div style="font-size: 12px; color: var(--text-mid);">Review anticoagulation adequacy, access function, blood flow. Consider: citrate dose optimisation, pre-dilution mode, access reversal trial, catheter exchange if dysfunction suspected.</div>
                </div>
            </div>`;
        }
        document.getElementById('contextWarnings').innerHTML = warnings;
    }

    function showQuickMode() {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.mode-btn')[0].classList.add('active');
    }

    function showDetailedMode() {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.mode-btn')[1].classList.add('active');
        alert('In v12, this would toggle to the current v11-style interface with full data entry fields \u2013 pre-populated with any Quick Mode selections.');
    }

    // Init
    updateNavButtons();
    updateCounts();

    // Version stamp — visible in console
    const REINA_VERSION = 'v12.1-fix';
    const REINA_BUILD = '2026-02-21';
    console.log(`%c REINA ${REINA_VERSION} (${REINA_BUILD}) loaded successfully `, 'background: #0e7490; color: white; padding: 4px 8px; border-radius: 4px;');

    // Global error handler
    window.onerror = function(msg, url, line, col, error) {
        console.error(`REINA error at line ${line}:${col}: ${msg}`);
        return false;
    };
</script>

</body>
</html>
