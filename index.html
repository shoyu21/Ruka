<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REINA v12 ‚Äî Quick Mode Wireframe</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0e7490;
            --primary-dark: #0a5a6e;
            --primary-light: #67e8f9;
            --primary-wash: #ecfeff;
            --accent: #6366f1;
            --accent-wash: #eef2ff;
            --success: #059669;
            --success-wash: #ecfdf5;
            --warning: #d97706;
            --warning-wash: #fffbeb;
            --danger: #dc2626;
            --danger-wash: #fef2f2;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #0f172a;
            --text-mid: #475569;
            --text-light: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --radius: 14px;
            --radius-sm: 8px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06), 0 2px 4px rgba(0,0,0,0.04);
            --shadow-lg: 0 12px 32px rgba(0,0,0,0.08), 0 4px 8px rgba(0,0,0,0.04);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
        .app {
            max-width: 860px;
            margin: 0 auto;
            padding: 24px 20px 80px;
        }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .header-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .header-badge .dot {
            width: 6px;
            height: 6px;
            background: var(--primary-light);
            border-radius: 50%;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
            letter-spacing: -0.5px;
            margin-bottom: 6px;
        }

        .header p {
            color: var(--text-mid);
            font-size: 15px;
            max-width: 520px;
            margin: 0 auto;
        }

        /* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
        .progress-bar {
            display: flex;
            align-items: center;
            gap: 0;
            margin-bottom: 32px;
            padding: 0 8px;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .progress-step .num {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            background: var(--border);
            color: var(--text-light);
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .progress-step.active .num {
            background: var(--primary);
            color: white;
            box-shadow: 0 0 0 4px rgba(14, 116, 144, 0.15);
        }

        .progress-step.done .num {
            background: var(--success);
            color: white;
        }

        .progress-step .label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-light);
            white-space: nowrap;
            transition: all 0.3s;
        }

        .progress-step.active .label {
            color: var(--primary);
            font-weight: 600;
        }

        .progress-step.done .label {
            color: var(--success);
        }

        .progress-line {
            flex: 1;
            height: 2px;
            background: var(--border);
            margin: 0 6px;
            transition: background 0.3s;
        }

        .progress-line.done {
            background: var(--success);
        }

        /* ‚îÄ‚îÄ STEP PANELS ‚îÄ‚îÄ */
        .step-panel {
            display: none;
            animation: fadeUp 0.35s ease;
        }

        .step-panel.active {
            display: block;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-question {
            font-size: 22px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 6px;
            letter-spacing: -0.3px;
        }

        .step-subtitle {
            font-size: 14px;
            color: var(--text-mid);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        /* ‚îÄ‚îÄ CHOICE CARDS ‚îÄ‚îÄ */
        .choice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .choice-grid.single-col {
            grid-template-columns: 1fr;
        }

        .choice-grid.triple {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .choice-card {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 18px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .choice-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .choice-card.selected {
            border-color: var(--primary);
            background: var(--primary-wash);
            box-shadow: 0 0 0 3px rgba(14, 116, 144, 0.12);
        }

        .choice-card.urgent {
            border-left: 4px solid var(--danger);
        }

        .choice-card.urgent.selected {
            background: var(--danger-wash);
            border-color: var(--danger);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .choice-card .icon {
            font-size: 22px;
            margin-bottom: 8px;
        }

        .choice-card .title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .choice-card .desc {
            font-size: 12px;
            color: var(--text-mid);
            line-height: 1.4;
        }

        .choice-card .check {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: transparent;
            transition: all 0.2s;
        }

        .choice-card.selected .check {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .choice-card.urgent.selected .check {
            background: var(--danger);
            border-color: var(--danger);
        }

        /* ‚îÄ‚îÄ SECTION DIVIDER ‚îÄ‚îÄ */
        .section-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-light);
            margin: 24px 0 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        /* ‚îÄ‚îÄ WEIGHT SELECTOR ‚îÄ‚îÄ */
        .weight-selector {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .weight-option {
            flex: 1;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 20px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .weight-option:hover {
            border-color: var(--primary);
        }

        .weight-option.selected {
            border-color: var(--primary);
            background: var(--primary-wash);
            box-shadow: 0 0 0 3px rgba(14, 116, 144, 0.12);
        }

        .weight-option .range {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
        }

        .weight-option .unit {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .weight-exact {
            margin-top: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .weight-exact label {
            font-size: 13px;
            color: var(--text-mid);
            white-space: nowrap;
        }

        .weight-exact input {
            width: 100px;
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            text-align: center;
            outline: none;
            transition: border 0.2s;
        }

        .weight-exact input:focus {
            border-color: var(--primary);
        }

        .weight-exact .suffix {
            font-size: 13px;
            color: var(--text-light);
        }

        /* ‚îÄ‚îÄ NAV BUTTONS ‚îÄ‚îÄ */
        .nav-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 22px;
            border-radius: var(--radius-sm);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-back {
            background: transparent;
            color: var(--text-mid);
        }

        .btn-back:hover {
            color: var(--text);
            background: var(--border-light);
        }

        .btn-next {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-next:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-next:disabled {
            background: var(--border);
            color: var(--text-light);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-generate {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            padding: 12px 28px;
            font-size: 15px;
            box-shadow: var(--shadow-md);
        }

        .btn-generate:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .selection-count {
            font-size: 12px;
            color: var(--text-light);
        }

        /* ‚îÄ‚îÄ OUTPUT PANEL ‚îÄ‚îÄ */
        .output-panel {
            display: none;
            animation: fadeUp 0.4s ease;
        }

        .output-panel.active {
            display: block;
        }

        .rx-card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .rx-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px 24px;
        }

        .rx-header h2 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .rx-header .subtitle {
            font-size: 13px;
            opacity: 0.85;
        }

        .rx-body {
            padding: 24px;
        }

        .rx-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .rx-item {
            padding: 14px 16px;
            background: var(--bg);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--primary);
        }

        .rx-item.highlight {
            border-left-color: var(--accent);
            background: var(--accent-wash);
        }

        .rx-item.warning {
            border-left-color: var(--warning);
            background: var(--warning-wash);
        }

        .rx-item .rx-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .rx-item .rx-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
        }

        .rx-item .rx-note {
            font-size: 11px;
            color: var(--text-mid);
            margin-top: 4px;
            line-height: 1.4;
        }

        .rx-full {
            grid-column: 1 / -1;
        }

        /* Clinical reasoning card */
        .reasoning-card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            margin-bottom: 16px;
        }

        .reasoning-header {
            padding: 14px 20px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reasoning-body {
            padding: 16px 20px;
        }

        .reasoning-item {
            display: flex;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
            font-size: 13px;
            color: var(--text-mid);
            line-height: 1.5;
        }

        .reasoning-item:last-child {
            border-bottom: none;
        }

        .reasoning-item .r-icon {
            flex-shrink: 0;
            margin-top: 2px;
        }

        .reasoning-item strong {
            color: var(--text);
        }

        .evidence-pill {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 4px;
        }

        /* ‚îÄ‚îÄ SELECTIONS SUMMARY ‚îÄ‚îÄ */
        .summary-strip {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 20px;
        }

        .summary-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--primary-wash);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .summary-tag.danger {
            background: var(--danger-wash);
            color: var(--danger);
        }

        .summary-tag.warning {
            background: var(--warning-wash);
            color: var(--warning);
        }

        /* ‚îÄ‚îÄ MODE TOGGLE ‚îÄ‚îÄ */
        .mode-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 28px;
        }

        .mode-toggle-inner {
            display: flex;
            background: var(--card);
            border-radius: 10px;
            padding: 4px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }

        .mode-btn {
            padding: 8px 20px;
            border-radius: 7px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            color: var(--text-mid);
            font-family: 'DM Sans', sans-serif;
        }

        .mode-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        /* ‚îÄ‚îÄ COMPARISON STRIP ‚îÄ‚îÄ */
        .comparison {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px 24px;
            margin-top: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }

        .comparison h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text);
        }

        .compare-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 16px;
            align-items: start;
        }

        .compare-col {
            font-size: 13px;
            line-height: 1.6;
        }

        .compare-col h4 {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .compare-arrow {
            font-size: 20px;
            color: var(--primary);
            padding-top: 24px;
        }

        .compare-col ul {
            list-style: none;
            padding: 0;
        }

        .compare-col li {
            padding: 3px 0;
            color: var(--text-mid);
        }

        .compare-col li::before {
            content: '‚Ä¢';
            color: var(--text-light);
            margin-right: 8px;
        }

        .compare-col.new li::before {
            content: '‚úì';
            color: var(--success);
        }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 640px) {
            .choice-grid { grid-template-columns: 1fr; }
            .choice-grid.triple { grid-template-columns: 1fr; }
            .rx-grid { grid-template-columns: 1fr; }
            .compare-row { grid-template-columns: 1fr; gap: 12px; }
            .compare-arrow { display: none; }
            .progress-step .label { display: none; }
            .weight-selector { flex-direction: column; }
        }

        /* ‚îÄ‚îÄ WIREFRAME NOTICE ‚îÄ‚îÄ */
        .wireframe-notice {
            text-align: center;
            padding: 10px;
            background: #fef3c7;
            color: #92400e;
            font-size: 12px;
            font-weight: 500;
            border-bottom: 1px solid #fde68a;
        }

        /* ‚îÄ‚îÄ RESTART ‚îÄ‚îÄ */
        .btn-restart {
            background: var(--bg);
            color: var(--text-mid);
            border: 1px solid var(--border);
            margin-top: 12px;
        }

        .btn-restart:hover {
            background: var(--border-light);
            border-color: var(--text-light);
        }

        /* ‚îÄ‚îÄ PROMPT CARD ‚îÄ‚îÄ */
        .prompt-card {
            background: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: var(--radius-sm);
            padding: 12px 16px;
            margin-top: 16px;
            font-size: 12px;
            color: #92400e;
            line-height: 1.5;
        }

        .prompt-card strong {
            display: block;
            margin-bottom: 4px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>

<div class="wireframe-notice">
    REINA v12 ‚Äî Quick Mode Wireframe / Interactive Prototype (for clinician feedback)
</div>

<div class="app">

    <!-- HEADER -->
    <div class="header">
        <div class="header-badge">
            <span>REINA v12</span>
            <span class="dot"></span>
            <span>QUICK MODE</span>
        </div>
        <h1>Goal-Directed RRT Prescription</h1>
        <p>5 clinical choices ‚Üí personalised CRRT prescription. No data entry required.</p>
    </div>

    <!-- MODE TOGGLE -->
    <div class="mode-toggle">
        <div class="mode-toggle-inner">
            <button class="mode-btn active" onclick="showQuickMode()">‚ö° Quick Mode</button>
            <button class="mode-btn" onclick="showDetailedMode()">üìã Detailed Mode</button>
        </div>
    </div>

    <!-- PROGRESS BAR -->
    <div class="progress-bar" id="progressBar">
        <div class="progress-step active" data-step="1" onclick="goToStep(1)">
            <div class="num">1</div>
            <div class="label">Indication</div>
        </div>
        <div class="progress-line" id="line1"></div>
        <div class="progress-step" data-step="2" onclick="goToStep(2)">
            <div class="num">2</div>
            <div class="label">Haemodynamics</div>
        </div>
        <div class="progress-line" id="line2"></div>
        <div class="progress-step" data-step="3" onclick="goToStep(3)">
            <div class="num">3</div>
            <div class="label">Bleeding Risk</div>
        </div>
        <div class="progress-line" id="line3"></div>
        <div class="progress-step" data-step="4" onclick="goToStep(4)">
            <div class="num">4</div>
            <div class="label">Context</div>
        </div>
        <div class="progress-line" id="line4"></div>
        <div class="progress-step" data-step="5" onclick="goToStep(5)">
            <div class="num">5</div>
            <div class="label">Weight</div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- STEP 1: WHY RRT? -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="step-panel active" id="step1">
        <div class="step-question">Why are you starting RRT?</div>
        <div class="step-subtitle">Select all that apply. This drives urgency assessment and modality selection.</div>

        <div class="section-label">Emergency Indications (Tier 1)</div>
        <div class="choice-grid">
            <div class="choice-card urgent" onclick="toggleChoice(this, 'indication')" data-value="refractory-k">
                <div class="check">‚úì</div>
                <div class="title">Refractory Hyperkalaemia</div>
                <div class="desc">K‚Å∫ not responding to medical therapy</div>
            </div>
            <div class="choice-card urgent" onclick="toggleChoice(this, 'indication')" data-value="severe-acidosis">
                <div class="check">‚úì</div>
                <div class="title">Severe Metabolic Acidosis</div>
                <div class="desc">pH &lt;7.1, ventilation not compensating</div>
            </div>
            <div class="choice-card urgent" onclick="toggleChoice(this, 'indication')" data-value="pulm-edema">
                <div class="check">‚úì</div>
                <div class="title">Refractory Pulmonary Oedema</div>
                <div class="desc">Diuretic-resistant, worsening oxygenation</div>
            </div>
            <div class="choice-card urgent" onclick="toggleChoice(this, 'indication')" data-value="uraemic">
                <div class="check">‚úì</div>
                <div class="title">Uraemic Complications</div>
                <div class="desc">Encephalopathy, pericarditis, bleeding</div>
            </div>
            <div class="choice-card urgent" onclick="toggleChoice(this, 'indication')" data-value="toxin">
                <div class="check">‚úì</div>
                <div class="title">Toxin / Overdose Removal</div>
                <div class="desc">Dialysable toxin per EXTRIP guidelines</div>
            </div>
        </div>

        <div class="section-label">Treatment Goals (Tier 2)</div>
        <div class="choice-grid">
            <div class="choice-card" onclick="toggleChoice(this, 'indication')" data-value="volume">
                <div class="check">‚úì</div>
                <div class="title">Volume Management</div>
                <div class="desc">Fluid overload, diuretic-resistant or intolerant</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'indication')" data-value="acidosis-correction">
                <div class="check">‚úì</div>
                <div class="title">Acidosis Correction</div>
                <div class="desc">Buffer delivery, permissive bicarb management</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'indication')" data-value="electrolyte">
                <div class="check">‚úì</div>
                <div class="title">Electrolyte Control</div>
                <div class="desc">K‚Å∫, Na‚Å∫, PO‚ÇÑ management beyond standard Rx</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'indication')" data-value="solute-clearance">
                <div class="check">‚úì</div>
                <div class="title">Solute Clearance</div>
                <div class="desc">Uraemia, supportive clearance in AKI</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'indication')" data-value="enable-nutrition">
                <div class="check">‚úì</div>
                <div class="title">Enable Nutrition / Medications</div>
                <div class="desc">Create fluid space for feeds, antibiotics, blood products</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'indication')" data-value="temp-mgmt">
                <div class="check">‚úì</div>
                <div class="title">Temperature Management</div>
                <div class="desc">Refractory hyperthermia, targeted temperature</div>
            </div>
        </div>

        <div class="nav-row">
            <div class="selection-count" id="step1Count">No selections yet</div>
            <button class="btn btn-next" id="step1Next" disabled onclick="nextStep()">Continue ‚Üí</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- STEP 2: HAEMODYNAMIC STATE -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="step-panel" id="step2">
        <div class="step-question">What's the haemodynamic picture?</div>
        <div class="step-subtitle">This determines modality preference and fluid removal tolerance. Select the best fit.</div>

        <div class="choice-grid single-col">
            <div class="choice-card" onclick="selectSingle(this, 'haemo')" data-value="stable">
                <div class="check">‚úì</div>
                <div class="icon">üü¢</div>
                <div class="title">Haemodynamically Stable</div>
                <div class="desc">No vasopressors, stable MAP. Tolerates fluid shifts. May be suitable for IHD if access available.</div>
            </div>
            <div class="choice-card" onclick="selectSingle(this, 'haemo')" data-value="stable-pressors">
                <div class="check">‚úì</div>
                <div class="icon">üü°</div>
                <div class="title">Stable on Low-Dose Vasopressors</div>
                <div class="desc">NAd ‚â§0.1 ¬µg/kg/min or equivalent. Stable trend. Can tolerate gentle UF. CRRT preferred.</div>
            </div>
            <div class="choice-card" onclick="selectSingle(this, 'haemo')" data-value="unstable-distributive">
                <div class="check">‚úì</div>
                <div class="icon">üî¥</div>
                <div class="title">Distributive Shock (Sepsis / Vasodilatory)</div>
                <div class="desc">Escalating vasopressors, warm peripheries, high cardiac output, low SVR. Septic, anaphylactic, or neurogenic.</div>
            </div>
            <div class="choice-card" onclick="selectSingle(this, 'haemo')" data-value="unstable-cardiogenic">
                <div class="check">‚úì</div>
                <div class="icon">üî¥</div>
                <div class="title">Cardiogenic Shock</div>
                <div class="desc">Low CO, elevated filling pressures, cool peripheries. Consider SCUF for volume. Very cautious UF rates.</div>
            </div>
            <div class="choice-card" onclick="selectSingle(this, 'haemo')" data-value="mixed">
                <div class="check">‚úì</div>
                <div class="icon">üü†</div>
                <div class="title">Mixed / Evolving Shock</div>
                <div class="desc">Components of multiple shock types or unclear. Haemodynamics fluctuating. Reassess frequently.</div>
            </div>
        </div>

        <div class="prompt-card">
            <strong>üß† Clinical Thinking Prompt</strong>
            If your patient is on multiple vasopressors or on ECMO, consider whether UF goals should be deferred. 
            Ross Prager: "Define the haemodynamic phenotype before writing the prescription."
        </div>

        <div class="nav-row">
            <button class="btn btn-back" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-next" id="step2Next" disabled onclick="nextStep()">Continue ‚Üí</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- STEP 3: BLEEDING RISK -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="step-panel" id="step3">
        <div class="step-question">What's the bleeding risk?</div>
        <div class="step-subtitle">This drives anticoagulation strategy. Select the primary concern.</div>

        <div class="choice-grid single-col">
            <div class="choice-card" onclick="selectSingle(this, 'bleeding')" data-value="low">
                <div class="check">‚úì</div>
                <div class="title">üü¢ Low Bleeding Risk</div>
                <div class="desc">No active bleeding, no recent surgery, adequate platelets, normal coagulation. Standard anticoagulation options available.</div>
            </div>
            <div class="choice-card" onclick="selectSingle(this, 'bleeding')" data-value="moderate">
                <div class="check">‚úì</div>
                <div class="title">üü° Moderate Bleeding Risk</div>
                <div class="desc">Recent surgery (48-72h), mild coagulopathy, thrombocytopaenia (50-100), therapeutic anticoagulation for other indication.</div>
            </div>
            <div class="choice-card" onclick="selectSingle(this, 'bleeding')" data-value="high">
                <div class="check">‚úì</div>
                <div class="title">üî¥ High Bleeding Risk</div>
                <div class="desc">Active bleeding, DIC, severe thrombocytopaenia (&lt;50), recent major surgery (&lt;48h), intracranial pathology.</div>
            </div>
            <div class="choice-card" onclick="selectSingle(this, 'bleeding')" data-value="hit">
                <div class="check">‚úì</div>
                <div class="title">‚ö†Ô∏è HIT Confirmed / Suspected</div>
                <div class="desc">Heparin-induced thrombocytopaenia. All heparin products contraindicated. Requires alternative anticoagulation.</div>
            </div>
            <div class="choice-card" onclick="selectSingle(this, 'bleeding')" data-value="liver-failure">
                <div class="check">‚úì</div>
                <div class="title">üü† Liver Failure / Coagulopathy</div>
                <div class="desc">Hepatic dysfunction with impaired citrate metabolism. INR elevated due to synthetic failure. Citrate requires close monitoring.</div>
            </div>
        </div>

        <div class="nav-row">
            <button class="btn btn-back" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-next" id="step3Next" disabled onclick="nextStep()">Continue ‚Üí</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- STEP 4: CLINICAL CONTEXT -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="step-panel" id="step4">
        <div class="step-question">Any special clinical context?</div>
        <div class="step-subtitle">Select any that apply. These modify the base prescription. Skip if none.</div>

        <div class="choice-grid">
            <div class="choice-card" onclick="toggleChoice(this, 'context')" data-value="brain-injury">
                <div class="check">‚úì</div>
                <div class="title">üß† Brain Injury / Raised ICP</div>
                <div class="desc">Avoid rapid osmolality shifts, target Na‚Å∫ stability</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'context')" data-value="ecmo">
                <div class="check">‚úì</div>
                <div class="title">üîÑ On ECMO</div>
                <div class="desc">Circuit integration considerations, shared anticoagulation</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'context')" data-value="post-cardiac">
                <div class="check">‚úì</div>
                <div class="title">ü´Ä Post-Cardiac Surgery</div>
                <div class="desc">Inflammatory response, volume sensitivity, mediastinal bleeding risk</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'context')" data-value="rhabdo">
                <div class="check">‚úì</div>
                <div class="title">üí™ Rhabdomyolysis</div>
                <div class="desc">High solute load, may need higher clearance, watch for hyperkalaemia</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'context')" data-value="tls">
                <div class="check">‚úì</div>
                <div class="title">üß¨ Tumour Lysis Syndrome</div>
                <div class="desc">Uric acid, PO‚ÇÑ, K‚Å∫ surge. High-intensity CRRT may be needed</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'context')" data-value="dysnatemia">
                <div class="check">‚úì</div>
                <div class="title">üß™ Significant Dysnatraemia</div>
                <div class="desc">Na‚Å∫ &lt;125 or &gt;155. Custom dialysate/replacement to control correction rate</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'context')" data-value="pregnancy">
                <div class="check">‚úì</div>
                <div class="title">ü§∞ Pregnancy</div>
                <div class="desc">Adjusted dosing, electrolyte targets, fetal considerations</div>
            </div>
            <div class="choice-card" onclick="toggleChoice(this, 'context')" data-value="circuit-issues">
                <div class="check">‚úì</div>
                <div class="title">üîÅ Recurrent Circuit Clotting</div>
                <div class="desc">Already on CRRT with frequent early filter loss. Re-evaluate anticoagulation.</div>
            </div>
        </div>

        <div class="nav-row">
            <button class="btn btn-back" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-next" onclick="nextStep()">Continue ‚Üí</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- STEP 5: WEIGHT -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="step-panel" id="step5">
        <div class="step-question">Patient weight</div>
        <div class="step-subtitle">Required for dose calculation (ml/kg/hr). Choose a range or enter exact weight.</div>

        <div class="weight-selector">
            <div class="weight-option" onclick="selectWeight(this, 'lt60')" data-value="lt60">
                <div class="range">&lt;60</div>
                <div class="unit">kg</div>
            </div>
            <div class="weight-option" onclick="selectWeight(this, '60-75')" data-value="60-75">
                <div class="range">60‚Äì75</div>
                <div class="unit">kg</div>
            </div>
            <div class="weight-option" onclick="selectWeight(this, 'gt75')" data-value="gt75">
                <div class="range">&gt;75</div>
                <div class="unit">kg</div>
            </div>
        </div>

        <div class="weight-exact">
            <label>Or enter exact:</label>
            <input type="number" id="exactWeight" placeholder="70" min="30" max="200" oninput="onExactWeight()">
            <span class="suffix">kg</span>
        </div>

        <div class="prompt-card">
            <strong>üí° Weight Consideration</strong>
            Use actual body weight for CRRT dosing in most patients. For morbidly obese patients (BMI &gt;40), consider adjusted body weight. 
            Protocol tables use the same 3 weight bands: &lt;60, 60‚Äì75, &gt;75 kg.
        </div>

        <div class="nav-row">
            <button class="btn btn-back" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-generate" onclick="generatePrescription()">Generate Prescription ‚Üí</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- OUTPUT -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="output-panel" id="outputPanel">

        <div class="step-question" style="margin-bottom: 16px;">Your CRRT Prescription</div>

        <!-- Summary of selections -->
        <div class="summary-strip" id="summaryStrip"></div>

        <!-- Main Rx Card -->
        <div class="rx-card">
            <div class="rx-header">
                <h2 id="rxTitle">CVVHDF ‚Äî Citrate Anticoagulation</h2>
                <div class="subtitle" id="rxSubtitle">Goal-directed prescription based on 5 clinical selections</div>
            </div>
            <div class="rx-body">
                <div class="rx-grid" id="rxGrid">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Clinical Reasoning -->
        <div class="reasoning-card">
            <div class="reasoning-header">üß† Clinical Reasoning ‚Äî Why This Prescription?</div>
            <div class="reasoning-body" id="reasoningBody">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Evidence Card -->
        <div class="reasoning-card">
            <div class="reasoning-header">üìö Evidence Base</div>
            <div class="reasoning-body" id="evidenceBody">
                <!-- Populated by JS -->
            </div>
        </div>

        <div style="text-align: center; margin-top: 24px;">
            <button class="btn btn-restart" onclick="restart()">‚Üê Start Over</button>
            <button class="btn btn-next" style="margin-left: 8px;" onclick="alert('In v12, this would switch to Detailed Mode with all fields pre-populated from your Quick Mode selections.')">Refine in Detailed Mode ‚Üí</button>
        </div>
    </div>

    <!-- COMPARISON -->
    <div class="comparison" id="comparison">
        <h3>v11 (Current) ‚Üí v12 Quick Mode (Proposed)</h3>
        <div class="compare-row">
            <div class="compare-col">
                <h4>v11 ‚Äî Data Entry</h4>
                <ul>
                    <li>Enter K‚Å∫, pH, UO, urea values</li>
                    <li>Select AKI stage &amp; duration</li>
                    <li>Enter platelets, INR, APTT</li>
                    <li>Enter haemodynamics, POCUS</li>
                    <li>Select conditions (10 buttons)</li>
                    <li>Adjust dose sliders</li>
                    <li>~15-20 fields to complete</li>
                </ul>
            </div>
            <div class="compare-arrow">‚Üí</div>
            <div class="compare-col new">
                <h4>v12 ‚Äî Clinical Choices</h4>
                <ul>
                    <li>Tap indication(s) ‚Äî why RRT?</li>
                    <li>Tap haemodynamic state</li>
                    <li>Tap bleeding risk level</li>
                    <li>Tap special contexts (optional)</li>
                    <li>Weight (range or exact)</li>
                    <li>5 taps ‚Üí full prescription</li>
                    <li>"Refine in Detailed Mode" bridge</li>
                </ul>
            </div>
        </div>
    </div>

</div>

<script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let currentStep = 1;
    const totalSteps = 5;

    const selections = {
        indication: new Set(),
        haemo: null,
        bleeding: null,
        context: new Set(),
        weight: null,
        exactWeight: null
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MULTI-SELECT (indication, context)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function toggleChoice(card, group) {
        const value = card.dataset.value;
        card.classList.toggle('selected');

        if (selections[group].has(value)) {
            selections[group].delete(value);
        } else {
            selections[group].add(value);
        }

        updateCounts();
        updateNavButtons();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SINGLE-SELECT (haemo, bleeding)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function selectSingle(card, group) {
        const panel = card.closest('.step-panel');
        panel.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        selections[group] = card.dataset.value;
        updateNavButtons();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // WEIGHT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function selectWeight(el, value) {
        document.querySelectorAll('.weight-option').forEach(w => w.classList.remove('selected'));
        el.classList.add('selected');
        selections.weight = value;
        document.getElementById('exactWeight').value = '';
        selections.exactWeight = null;
    }

    function onExactWeight() {
        const val = document.getElementById('exactWeight').value;
        if (val) {
            document.querySelectorAll('.weight-option').forEach(w => w.classList.remove('selected'));
            selections.exactWeight = parseFloat(val);
            selections.weight = val < 60 ? 'lt60' : val <= 75 ? '60-75' : 'gt75';
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NAVIGATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function nextStep() {
        if (currentStep < totalSteps) {
            currentStep++;
            renderStep();
        }
    }

    function prevStep() {
        if (currentStep > 1) {
            currentStep--;
            renderStep();
        }
    }

    function goToStep(n) {
        if (n <= currentStep || n <= getMaxAllowedStep()) {
            currentStep = n;
            renderStep();
        }
    }

    function getMaxAllowedStep() {
        // Allow navigating back to completed steps
        return totalSteps;
    }

    function renderStep() {
        document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
        document.getElementById(`step${currentStep}`).classList.add('active');
        document.getElementById('outputPanel').classList.remove('active');

        // Update progress
        document.querySelectorAll('.progress-step').forEach(s => {
            const step = parseInt(s.dataset.step);
            s.classList.remove('active', 'done');
            if (step === currentStep) s.classList.add('active');
            else if (step < currentStep) s.classList.add('done');
        });

        for (let i = 1; i < totalSteps; i++) {
            const line = document.getElementById(`line${i}`);
            line.classList.toggle('done', i < currentStep);
        }

        updateNavButtons();
    }

    function updateNavButtons() {
        const btn1 = document.getElementById('step1Next');
        const btn2 = document.getElementById('step2Next');
        const btn3 = document.getElementById('step3Next');

        if (btn1) btn1.disabled = selections.indication.size === 0;
        if (btn2) btn2.disabled = !selections.haemo;
        if (btn3) btn3.disabled = !selections.bleeding;
    }

    function updateCounts() {
        const count1 = document.getElementById('step1Count');
        if (count1) {
            const n = selections.indication.size;
            count1.textContent = n === 0 ? 'No selections yet' : `${n} indication${n > 1 ? 's' : ''} selected`;
        }
    }

    function restart() {
        currentStep = 1;
        selections.indication.clear();
        selections.haemo = null;
        selections.bleeding = null;
        selections.context.clear();
        selections.weight = null;
        selections.exactWeight = null;

        document.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected'));
        document.querySelectorAll('.weight-option').forEach(w => w.classList.remove('selected'));
        document.getElementById('exactWeight').value = '';

        renderStep();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GENERATE PRESCRIPTION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function generatePrescription() {
        // Hide steps, show output
        document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
        document.getElementById('outputPanel').classList.add('active');

        // Mark all progress done
        document.querySelectorAll('.progress-step').forEach(s => s.classList.add('done'));
        document.querySelectorAll('.progress-step').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.progress-line').forEach(l => l.classList.add('done'));

        // Determine prescription
        const hasEmergency = ['refractory-k', 'severe-acidosis', 'pulm-edema', 'uraemic', 'toxin']
            .some(e => selections.indication.has(e));
        const isDistributive = selections.haemo === 'unstable-distributive';
        const isCardiogenic = selections.haemo === 'unstable-cardiogenic';
        const highBleed = selections.bleeding === 'high';
        const isHIT = selections.bleeding === 'hit';
        const liverFail = selections.bleeding === 'liver-failure';
        const hasBrainInjury = selections.context.has('brain-injury');
        const hasECMO = selections.context.has('ecmo');
        const hasRhabdo = selections.context.has('rhabdo');
        const hasTLS = selections.context.has('tls');
        const hasCircuitIssues = selections.context.has('circuit-issues');

        // Weight
        const weight = selections.exactWeight || (selections.weight === 'lt60' ? 55 : selections.weight === '60-75' ? 67 : 85);

        // === MODALITY LOGIC ===
        let modality = 'CVVHDF';
        let modalityReason = 'Default: balanced convective + diffusive clearance';

        if (selections.indication.has('toxin') || hasTLS || hasRhabdo) {
            modality = 'CVVHDF';
            modalityReason = 'High solute load ‚Üí combination modality for maximum clearance';
        } else if (selections.indication.has('volume') && selections.indication.size === 1) {
            modality = 'SCUF';
            modalityReason = 'Isolated volume management ‚Üí slow continuous ultrafiltration';
            if (isCardiogenic) modalityReason += ' (preferred in cardiogenic shock)';
        } else if (isDistributive && selections.indication.has('electrolyte')) {
            modality = 'CVVHD';
            modalityReason = 'Septic shock + electrolyte goals ‚Üí diffusive clearance, less haemodynamic impact';
        }

        // === ANTICOAGULATION LOGIC ===
        let anticoag = 'Regional Citrate (RCA)';
        let anticoagReason = 'First-line per KDIGO. Longer circuit life, no systemic anticoagulation.';

        if (liverFail) {
            anticoag = 'Regional Citrate ‚Äî CLOSE MONITORING';
            anticoagReason = 'Liver failure: citrate metabolism impaired. Monitor total:ionised Ca¬≤‚Å∫ ratio Q4h. Consider no anticoagulation if ratio rises.';
        } else if (isHIT) {
            anticoag = 'Argatroban or Regional Citrate';
            anticoagReason = 'HIT: all heparin products contraindicated. RCA preferred if available, argatroban if not.';
        } else if (highBleed) {
            anticoag = 'Regional Citrate (preferred) or None';
            anticoagReason = 'High bleeding risk: RCA avoids systemic anticoagulation. Accept shorter filter life if no anticoag used.';
        } else if (hasECMO) {
            anticoag = 'Systemic Heparin (shared with ECMO circuit)';
            anticoagReason = 'ECMO already requires systemic heparin. Avoid additional citrate complexity.';
        }

        // === DOSE LOGIC ===
        let prescribedDose = 35;
        let doseReason = 'Standard 35 ml/kg/hr prescribed ‚Üí ~25 ml/kg/hr delivered (RENAL/ATN evidence base)';

        if (hasTLS || hasRhabdo) {
            prescribedDose = 40;
            doseReason = 'High solute load ‚Üí higher prescribed dose. Monitor delivered dose closely.';
        } else if (isCardiogenic) {
            prescribedDose = 30;
            doseReason = 'Cardiogenic shock ‚Üí conservative dosing. Prioritise haemodynamic stability over clearance.';
        }

        const doseAbsolute = Math.round(prescribedDose * weight);
        const deliveredEstimate = Math.round(prescribedDose * 0.72);

        // === BLOOD FLOW ===
        let bloodFlow = 150;
        if (selections.weight === 'lt60') bloodFlow = 120;
        if (hasECMO) bloodFlow = 150;

        // === UF RATE ===
        let ufRate = '50‚Äì100 ml/hr';
        let ufReason = 'Standard gentle UF';

        if (isCardiogenic) {
            ufRate = '25‚Äì50 ml/hr (MAX)';
            ufReason = 'Cardiogenic shock: very cautious fluid removal. Reassess MAP/CO continuously.';
        } else if (isDistributive) {
            ufRate = '0‚Äì50 ml/hr initially';
            ufReason = 'Active distributive shock: may not tolerate net UF. Prioritise clearance over fluid removal.';
        } else if (selections.indication.has('pulm-edema')) {
            ufRate = '100‚Äì200 ml/hr';
            ufReason = 'Pulmonary oedema: more aggressive UF tolerated if MAP maintained.';
        }

        // Build summary strip
        const summaryStrip = document.getElementById('summaryStrip');
        summaryStrip.innerHTML = '';

        const labels = {
            'refractory-k': ['üö® Refractory K‚Å∫', 'danger'],
            'severe-acidosis': ['üö® Severe Acidosis', 'danger'],
            'pulm-edema': ['üö® Pulm Oedema', 'danger'],
            'uraemic': ['üö® Uraemic', 'danger'],
            'toxin': ['üö® Toxin Removal', 'danger'],
            'volume': ['üíß Volume Mgmt', ''],
            'acidosis-correction': ['‚öóÔ∏è Acidosis Rx', ''],
            'electrolyte': ['üß™ Electrolyte', ''],
            'solute-clearance': ['üî¨ Solute Clearance', ''],
            'enable-nutrition': ['ü•§ Enable Nutrition', ''],
            'temp-mgmt': ['üå°Ô∏è Temperature', ''],
            'brain-injury': ['üß† Brain Injury', 'warning'],
            'ecmo': ['üîÑ ECMO', 'warning'],
            'post-cardiac': ['ü´Ä Post-Cardiac', ''],
            'rhabdo': ['üí™ Rhabdomyolysis', 'warning'],
            'tls': ['üß¨ TLS', 'warning'],
            'dysnatemia': ['üß™ Dysnatraemia', 'warning'],
            'pregnancy': ['ü§∞ Pregnancy', ''],
            'circuit-issues': ['üîÅ Circuit Issues', 'warning']
        };

        selections.indication.forEach(v => {
            const [text, cls] = labels[v] || [v, ''];
            summaryStrip.innerHTML += `<span class="summary-tag ${cls}">${text}</span>`;
        });
        selections.context.forEach(v => {
            const [text, cls] = labels[v] || [v, ''];
            summaryStrip.innerHTML += `<span class="summary-tag ${cls}">${text}</span>`;
        });

        // Title
        document.getElementById('rxTitle').textContent = `${modality} ‚Äî ${anticoag}`;
        document.getElementById('rxSubtitle').textContent = `Generated from ${selections.indication.size} indication(s) ‚Ä¢ ${weight} kg ‚Ä¢ ${hasEmergency ? 'URGENT' : 'Standard'} priority`;

        // Build Rx grid
        const grid = document.getElementById('rxGrid');
        grid.innerHTML = `
            <div class="rx-item">
                <div class="rx-label">Modality</div>
                <div class="rx-value">${modality}</div>
                <div class="rx-note">${modalityReason}</div>
            </div>
            <div class="rx-item highlight">
                <div class="rx-label">Anticoagulation</div>
                <div class="rx-value" style="font-size: 14px;">${anticoag}</div>
                <div class="rx-note">${anticoagReason}</div>
            </div>
            <div class="rx-item">
                <div class="rx-label">Prescribed Dose</div>
                <div class="rx-value">${prescribedDose} ml/kg/hr</div>
                <div class="rx-note">${doseAbsolute} ml/hr absolute (${weight} kg)</div>
            </div>
            <div class="rx-item">
                <div class="rx-label">Expected Delivered</div>
                <div class="rx-value">~${deliveredEstimate} ml/kg/hr</div>
                <div class="rx-note">At ~72% efficiency (circuit downtime, clotting)</div>
            </div>
            <div class="rx-item">
                <div class="rx-label">Blood Flow Rate</div>
                <div class="rx-value">${bloodFlow} ml/min</div>
                <div class="rx-note">Per MICU protocol for ${selections.weight === 'lt60' ? '<60' : selections.weight === '60-75' ? '60-75' : '>75'} kg</div>
            </div>
            <div class="rx-item ${isCardiogenic || isDistributive ? 'warning' : ''}">
                <div class="rx-label">Net UF Rate</div>
                <div class="rx-value">${ufRate}</div>
                <div class="rx-note">${ufReason}</div>
            </div>
            ${hasBrainInjury ? `
            <div class="rx-item warning rx-full">
                <div class="rx-label">‚ö†Ô∏è Brain Injury Modification</div>
                <div class="rx-value" style="font-size: 13px;">Custom dialysate Na‚Å∫ to match serum ¬±5 mmol/L</div>
                <div class="rx-note">Avoid rapid osmolality shifts. Monitor Na‚Å∫ Q4h. Target correction rate &lt;8 mmol/24h.</div>
            </div>` : ''}
            ${hasCircuitIssues ? `
            <div class="rx-item warning rx-full">
                <div class="rx-label">üîÅ Circuit Clotting Strategy</div>
                <div class="rx-value" style="font-size: 13px;">Review anticoagulation adequacy, access function, blood flow</div>
                <div class="rx-note">Consider: citrate dose optimisation, pre-dilution mode, access reversal trial, catheter exchange if dysfunction suspected.</div>
            </div>` : ''}
        `;

        // Build reasoning
        const reasoningBody = document.getElementById('reasoningBody');
        let reasoning = '';

        reasoning += `<div class="reasoning-item"><span class="r-icon">üéØ</span><span><strong>Modality:</strong> ${modalityReason}</span></div>`;
        reasoning += `<div class="reasoning-item"><span class="r-icon">üõ°Ô∏è</span><span><strong>Anticoagulation:</strong> ${anticoagReason}</span></div>`;
        reasoning += `<div class="reasoning-item"><span class="r-icon">üíä</span><span><strong>Dose:</strong> ${doseReason}</span></div>`;
        reasoning += `<div class="reasoning-item"><span class="r-icon">üíß</span><span><strong>UF Rate:</strong> ${ufReason}</span></div>`;

        if (hasEmergency) {
            reasoning += `<div class="reasoning-item"><span class="r-icon">üö®</span><span><strong>Urgency:</strong> Emergency indication present. Do not delay initiation for optimisation. Start now, refine later.</span></div>`;
        }

        reasoningBody.innerHTML = reasoning;

        // Build evidence
        const evidenceBody = document.getElementById('evidenceBody');
        let evidence = '';
        evidence += `<div class="reasoning-item"><span class="r-icon">üìñ</span><span><strong>RENAL Trial (2009):</strong> 25 vs 40 ml/kg/hr ‚Äî no difference in 90-day mortality. Target delivered dose 20‚Äì25. <span class="evidence-pill">N=1508</span></span></div>`;
        evidence += `<div class="reasoning-item"><span class="r-icon">üìñ</span><span><strong>ATN Trial (2008):</strong> Intensive vs standard dosing ‚Äî no benefit from higher dose. <span class="evidence-pill">N=1124</span></span></div>`;

        if (hasTLS || hasRhabdo) {
            evidence += `<div class="reasoning-item"><span class="r-icon">üìñ</span><span><strong>IVOIRE Trial:</strong> 70 vs 35 ml/kg/hr in septic AKI ‚Äî no mortality benefit from high-volume HF. <span class="evidence-pill">N=140</span></span></div>`;
        }

        if (hasEmergency) {
            evidence += `<div class="reasoning-item"><span class="r-icon">üìñ</span><span><strong>STARRT-AKI (2020):</strong> Accelerated vs standard timing ‚Äî no benefit from early start. But emergency indications (Tier 1) override timing studies. <span class="evidence-pill">N=2927</span></span></div>`;
        }

        evidence += `<div class="reasoning-item"><span class="r-icon">üìñ</span><span><strong>KDIGO 2012:</strong> Regional citrate anticoagulation recommended as first-line for CRRT in patients without contraindications.</span></div>`;

        evidenceBody.innerHTML = evidence;
    }

    function showQuickMode() {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.mode-btn')[0].classList.add('active');
    }

    function showDetailedMode() {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.mode-btn')[1].classList.add('active');
        alert('In v12, this would toggle to the current v11-style interface with full data entry fields ‚Äî pre-populated with any Quick Mode selections.');
    }

    // Init
    updateNavButtons();
    updateCounts();
</script>

</body>
</html>
